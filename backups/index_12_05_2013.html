<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	</head>
	<body>
		<style type="text/css">
			body{
				background-image:url("GUI/diag_lines.png");
				background-repeat:repeat;
			} 
		</style>
	
		<div id="BattleTextDiv" style="position:absolute; top:200px; left:10px; width:250px; height:50px;">
			<textarea id="battleText" rows="2" oninput="updateImage();" style="width: 250px; resize: none; font-size:12px">Trainer X wants to battle!</textarea>
		</div>
		
		<div id="GenInfoDiv" style="position:absolute; top:200px; left:20px; width:50px; height:10px; font-size:7pt; color:#FFF; visibility:hidden; pointer-events:none">
			Some Gen!
		</div>
		
		<canvas id="myCanvas" width="1200" height="570"></canvas> 
		
		<script>
			if(typeof String.prototype.startsWith != 'function'){
			  String.prototype.startsWith = function(str){
			    return this.lastIndexOf(str, 0) == 0;
			  };
			}
			
			if(!HTMLCanvasElement.prototype.x){
				HTMLCanvasElement.prototype.x = 0;
			}
			
			if(!HTMLCanvasElement.prototype.y){
				HTMLCanvasElement.prototype.y = 0;
			}
			
			if(!CanvasRenderingContext2D.prototype.drawToContext){
				CanvasRenderingContext2D.prototype.drawToContext = function(c, clearFirst){
					if(clearFirst){
//						alert(c+" - "+this.x);
						c.clearRect(this.canvas.x, this.canvas.y, this.canvas.width, this.canvas.height);
					}
					c.drawImage(this.canvas, this.canvas.x, this.canvas.y);
			  };
			}
			
			if(!CanvasRenderingContext2D.prototype.drawRoundedRect){
				CanvasRenderingContext2D.prototype.drawRoundedRect = function(x, y, width, height, radius, fill, stroke, lineWidth){
					this.beginPath();
					this.moveTo(x + radius, y);
					this.lineTo(x + width - radius, y);
					this.quadraticCurveTo(x + width, y, x + width, y + radius);
					this.lineTo(x + width, y + height - radius);
					this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
					this.lineTo(x + radius, y + height);
					this.quadraticCurveTo(x, y + height, x, y + height - radius);
					this.lineTo(x, y + radius);
					this.quadraticCurveTo(x, y, x + radius, y);
					this.closePath();
					
					if(fill != undefined){
//						alert(this);
						this.fillStyle = fill;
						this.fill();
					}
					
					if(stroke != undefined){
						this.strokeStyle = stroke;
						this.lineWidth = lineWidth;
						this.stroke();
					}        
				}
			}
			
			function Bounds(x, y, w, h, section, execute, update, ac){
				this.x = x;
				this.y = y;
				this.w = w;
				this.h = h;
				this.section = section;
				this.execute = execute;
				this.ac = (ac==undefined) ? true : ac;
				if(update){
					this.update = update;
				}
				else{
					this.update = function(){}; //empty function; kinda ugly?
				}
				this.inBounds = function(x, y){
					return x >= this.x && x <= this.x + this.w && y >= this.y && y <= this.y + this.h;
				}
			}
			
			function Button(name, img_src, x, y, hasActive, gctx, section, execute, update, activatedOnStart, ac){
				this.x = x;
				this.y = y;
				this.gctx = gctx;
				this.enabled = false;
				
				var _ac = (ac==undefined) ? true : ac;
				
				if(hasActive){
					var btn_enabled = new Image();
					btn_enabled.src = img_src+"_active.png";
				}
				var btn_disabled = new Image();
				btn_disabled.src = img_src+".png";
				btn_disabled.onload = function(){
					if(!activatedOnStart && _ac){ //abuse ac for first-time drawing
						gctx.drawImage(btn_disabled, x, y);
						gctx.drawToContext(ctx, true);
					}
					bounds[name] = new Bounds(x + gctx.canvas.x, y + gctx.canvas.y, btn_disabled.width, btn_disabled.height, section, execute, update, _ac);
				}
				
				this.activate = function(){
					if(_ac){ //abuse ac for first-time drawing
						if(btn_enabled.complete){
							gctx.drawImage(btn_enabled, x, y);
							gctx.drawToContext(ctx, true);
							this.enabled = true;
						}
						else{
							btn_enabled.onload = function(){
								gctx.drawImage(btn_enabled, x, y);
								gctx.drawToContext(ctx, true);
								this.enabled = true;
							}
						}
					}
				}
				
				this.deactivate = function(){
					gctx.drawImage(btn_disabled, x, y);
					gctx.drawToContext(ctx, true);
					this.enabled = false;
				}
				
				this.toggle = function(){
					this.enabled = !this.enabled;
					gctx.drawImage(this.enabled ? btn_enabled : btn_disabled, x, y);
					gctx.drawToContext(ctx, true);
				}
				
				this.draw = function(){ //sometimes a manual redraw is needed
					gctx.drawImage(this.enabled ? btn_enabled : btn_disabled, x, y);
					gctx.drawToContext(ctx, true);
				}
			}
			
			function Sprite(img, x, y, offsetY, num, gen){
				this.img = img;
				this.x = x;
				this.y = y;
				this.offsetY = offsetY;
				this.num = num;
				this.gen = gen;
			}
			
			var updateUI = function(menu, active){
				return function(){
					var set; 
					switch(menu){
						case 'tabs':	set = tabs;							break;
						case 'buttons':	set = buttons;						break;
						case 'gender':	set = genderButtons;				break;
						case 'shiny':	shinyButton.toggle();	return;		break;
						case 'zoom':	set = zoomButtons;					break;
					}
						
					for(var i=0; i<set.length; i++){
						if(i == active){
							set[i].activate();
						}
						else{
							set[i].deactivate();
						}
					}
				}
			}
			
			var setPokemon = function(numPokemon, gen, redrawEditor){
				return function(){
					if(numPokemon == 0){ //remove
						updatePokemon(context.main == 'self' ? 0 : 1, undefined);
						updateImage();
					}
					else{
						var curPokemon = pokemon[context.main == 'self' ? 0 : 1][context.pokemonNum];
						if(curPokemon && curPokemon.num == numPokemon && curPokemon.gen == gen){
							return;
						}
						var i_pokemon = new Image();
						i_pokemon.src = getPokemonImagePath(numPokemon, gen)//"pokemon/"+genPaths[gen]+"/"+numPokemon+".png";
						i_pokemon.onload = function(){
							var c_sprite = document.createElement('canvas');
							c_sprite.width = c_sprite.height = spriteSize;
							var ctx_sprite = c_sprite.getContext('2d');
							ctx_sprite.drawImage(i_pokemon, 0, 0);
							var imgData = ctx_sprite.getImageData(0, 0, spriteSize, spriteSize).data;
							
							var topRow = -1;
							for(var i=0; i<spriteSize; i++){ //scan every row of pixels (line)
								var colorFound = false;
								for(var p=0; p<spriteSize*4; p+=16){ //check every 4 pixels;
									if(imgData[i*spriteSize*4 + p + 3] != 0){ //+3 = alpha channel
										colorFound = true;
										if(topRow == -1){
											topRow = i;
										}
										break;
									}
								}
								if((!colorFound || i==spriteSize-1) && topRow != -1 && i-topRow > 10){
									if(context.main == 'self'){
										if(gen < 12){
											var genCorrection = 0;
											if(gen < 3){
												genCorrection = 8;
											}
											updatePokemon(0, new Sprite(i_pokemon, 0, 0, -(i+genCorrection), numPokemon, gen));
										}
										else{
											updatePokemon(0, new Sprite(i_pokemon, 0, 0, 0, numPokemon, gen));
										}
									}
									else{
										var sizeCorrection = Math.max(0, (Math.min(70, i-topRow)-35)/35) * 8; //Remap to 35-70 --> 0-21
										var weightedFloorLevel = parseInt(spriteSize-i + sizeCorrection);
										updatePokemon(1, new Sprite(i_pokemon, 0, 0, weightedFloorLevel, numPokemon, gen));
									}
									updateImage();
									if(redrawEditor){
										updateEditor(numPokemon, 2, 'gens');
									}
									break;
								}
							}
						}
					}
				}
			};
			
			var setTrainer = function(numTrainer, gen, pose, redrawEditor){
				return function(){
					var char = context.main == 'self' ? 0 : 1;
					if(numTrainer == 0){ //remove
						trainers[char] = undefined;
						updateImage();
					}
					else{
						var path = "characters/trainers/"+(char == 0 ? "back" : "front")+"/";
						var prevTrainers = 0;
						if(numTrainer > 0){
							for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", ...]
								if(numTrainer < numTrainers[char][i] + prevTrainers){
									path += trainerPaths[i]+"/"+(numTrainer - prevTrainers)+"/"+trainerGenPaths[gen]; //path is now /front/Heroes/1/rgb e.g.
								}
								else{
									prevTrainers += numTrainers[char][i];
								}
							}
						}
						
						var i_trainer = new Image();
						i_trainer.src = path+"/"+pose+".png";
						i_trainer.onload = function(){
							var corrX = char == 0 ? 0 : Math.round((96 - i_trainer.width)*0.5);
							var corrY = 0;//Math.round((96 - i_trainer.height)*0.5);
							
							if(char == 1){
								var c_sprite = document.createElement('canvas');
								c_sprite.width = i_trainer.width;
								c_sprite.height = i_trainer.height;
								var ctx_sprite = c_sprite.getContext('2d');
								ctx_sprite.drawImage(i_trainer, 0, 0);
								var imgData = ctx_sprite.getImageData(0, 0, i_trainer.width, i_trainer.height).data;
								
								var topRow = -1;
								for(var i=0; i<i_trainer.height; i++){ //scan every row of pixels (line)
									var colorFound = false;
									for(var p=0; p<i_trainer.width*4; p+=16){ //check every 4 pixels;
										if(imgData[i*i_trainer.width*4 + p + 3] != 0){ //+3 = alpha channel
											colorFound = true;
											if(topRow == -1){
												topRow = i;
											}
											break;
										}
									}
									if((!colorFound || i==i_trainer.height-1) && topRow != -1){
										corrY = -i;
										break;
									}
								}
							}
							else{
								corrY = 80 - i_trainer.height;
							}
//							alert(char + " - " + corrX + " - " + corrY);
							trainers[char] = new Sprite(i_trainer, trainerPos[char][0] + corrX, trainerPos[char][1] + corrY, 0, numTrainer, pose);
							updateImage();
						}
					}
					
					if(redrawEditor){
						updateEditor(numTrainer, 2, 'gens');
					}
				}	
			}
			
			function updatePokemon(char, sprite){
				if(sprite){
					pokemon[char][context.pokemonNum] = sprite;
				}
				else{
					pokemon[char][context.pokemonNum] = undefined;
				}
				
				var totPokemon = (pokemon[char][0] ? 1 : 0) + (pokemon[char][1] ? 1 : 0) + (pokemon[char][2] ? 1 : 0);
				
				if(totPokemon >= 0){
					var curPos = 0;
					for(var i=0; i<3; i++){
						if(pokemon[char][i]){
							var oldGenCorrection = (context.main == 'self' && pokemon[char][i].gen < 12) ? 0 : 1;
							var coords = posPokemon[char+oldGenCorrection][totPokemon-1][curPos];		//char, singdoubtrip, pos, x/y
							var offsetX = 0; //Gen IV+
							if(pokemon[char][i].gen < 6){
								offsetX = 20;
							}
							else if(pokemon[char][i].gen < 9){
								offsetX = 8;
							}
							pokemon[char][i] = new Sprite(pokemon[char][i].img, coords[0]+offsetX, coords[1]+pokemon[char][i].offsetY,
														  pokemon[char][i].offsetY, pokemon[char][i].num, pokemon[char][i].gen);
							curPos++;
						}
					}
				}
			}
			
			var updateCharacteristics = function(){
//				return function(){
					var char = context.main=='self' ? 0 : 1;
					var num = pokemon[char][context.pokemonNum].num;
					var gen = pokemon[char][context.pokemonNum].gen;
					
					var path = getPokemonImagePath(num, gen);
					
					var i_pokemon = new Image();
					i_pokemon.src = path;
					i_pokemon.onload = function(weightedFloorLevel, num, gen){
						return function(){
							updatePokemon(char, new Sprite(i_pokemon, 0, 0, weightedFloorLevel, num, gen));
							updateImage();
							updateEditor(undefined, 0);
						}
					}(pokemon[char][context.pokemonNum].offsetY, num, gen);
//				}
			}
			
			function getPokemonImagePath(num, gen){
				var path = "pokemon/"+genPaths[gen]+"/";
				if(context.main == 'self'){
					path += "back/";
				}
//				if(document.getElementById('characteristic_shiny').checked && gen > 2){
				if(shinyButton.enabled && gen > 2){
					path += "shiny/";
				}
//				if(document.getElementById('characteristic_female').checked && gen > 8){
				if(genderButtons[1].enabled && gen > 8){
					var req = new XMLHttpRequest();
				    req.open('GET', "fileExists.php?path="+path+"female/"+num+".png", false);
				    req.onreadystatechange = function(){
				    	if(req.responseText == 1){
							path += "female/";
				    	}
				    }
				    req.send();
				}
				path += num+".png";
				return path;
			}
			
			function drawSprite(sprite){
				if(sprite){
//					alert(sprite.x+" - "+sprite.y);
					ctx_image.drawImage(sprite.img, sprite.x, sprite.y);
				}
			}
			
			function updateImage(){
				var w = renderSizes[context.zoomLevel][0];
				var h = renderSizes[context.zoomLevel][1];
				
				ctx.clearRect(0, 0, w, h); //final image dimensions
				ctx_image.clearRect(0, 0, renderSizes[0][0], renderSizes[0][1]); //final image dimensions
				
				ctx_image.drawImage(environment[context.environment][context.time], 0, 0);
				ctx_image.drawImage(bases[context.environment][0], -42, 117);
				ctx_image.drawImage(bases[context.environment][1], 128, 56);
				
				drawSprite(pokemon[0][0]);
				drawSprite(pokemon[0][1]);
				drawSprite(pokemon[0][2]);
				drawSprite(trainers[0]);
				
				drawSprite(trainers[1]);
				drawSprite(pokemon[1][0]);
				drawSprite(pokemon[1][2]);
				drawSprite(pokemon[1][1]);
				
				updateTextArea();
				
				ctx.drawImage(c_image, 0, 0, w, h);
			}
			
			function updateTextArea(){
				ctx_image.fillRect(0, 144, 256, 46);
				ctx_image.putImageData(textBoxes[0], 0, 144);
//				alert(textBoxes[0].data[3]);
//				alert(document.getElementById("battleText").value);
				ctx_image.fillText(document.getElementById("battleText").value, 20, 165);
			}
			
			function updateSelector(){
//				alert('us');
//				ctx.clearRect(iconX+c_selector.x, iconY+c_selector.y, iconColumns[1]*iconSizes[1], iconRows[1]*iconSizes[1]);
//				ctx_selector.clearRect(iconX, iconY, iconColumns[1]*iconSizes[1], iconRows[1]*iconSizes[1]);
				ctx.clearRect(c_selector.x, c_selector.y, c_selector.width, c_selector.height);
				ctx_selector.clearRect(0, 0, c_selector.width, c_selector.height);
				
//				ctx_selector.drawRoundedRect(sectionLineWidth, sectionLineWidth+12, c_selector.width-sectionLineWidth*2, sectionLineWidth+28, 6,
//											 sectionFill, sectionStroke, sectionLineWidth);
				
//				ctx_selector.drawRoundedRect(sectionLineWidth, sectionLineWidth+43, c_selector.width-sectionLineWidth*2,
//											 c_selector.height-sectionLineWidth*2-60, 6, sectionFill, sectionStroke, sectionLineWidth);

				
				ctx_selector.drawRoundedRect(sectionLineWidth, sectionLineWidth, c_selector.width-sectionLineWidth*2, sectionLineWidth+63, 6,
											 sectionFill, sectionStroke, sectionLineWidth);
											 
				ctx_selector.drawRoundedRect(sectionLineWidth, sectionLineWidth+66, c_selector.width-sectionLineWidth*2,
											 c_selector.height-sectionLineWidth*2-90, 6, sectionFill, sectionStroke, sectionLineWidth);
				
				switch(context.sub){
//					case 'trainer':	for(var i=0; i<17; i++){ //17 = numTrainers
//										var n = i;// + iconColumns[0]*iconRows[1]*context.trainerpage;
//										var img = new Image();
//										img.src = n==0 ? "GUI/del.png" : "characters/trainers/"+n+"/0.png";
//										img.onload = (function(img, i, n){
//											return function(){
//												var x = iconX + (i%iconColumns[0])*iconSizes[0];
//												var y = iconY + Math.floor(i/iconColumns[0])*iconSizes[0];
//												
////												ctx.clearRect(c_selector.x, c_selector.y, c_selector.width, c_selector.height);
//												ctx_selector.drawImage(img, x, y, iconSizes[0], iconSizes[0]);
//												ctx_selector.drawToContext(ctx, true);
////												ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
//												bounds["trainer"+i] = new Bounds(x+c_selector.x, y+c_selector.y, iconSizes[0], iconSizes[0], 'selector', setTrainer(n, 0, true));
//											}
//										})(img, i, n);
//									}
//									break;
					
					case 'trainer':	//if(context.main == 'opp'){
										var trainerTotal = 0;
										var char = context.main == 'self' ? 0 : 1;
										
										for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", "Friends", ...].length
											var prevFound = 0;
											
											var path = "characters/trainers/"+(context.main == 'self' ? "back" : "front")+"/"+trainerPaths[i];
//											var findNext = numTrainers[i] == 0;
											var findNext = trainerGens[char].length == trainerTotal;
											
											while(findNext){
												var req = new XMLHttpRequest();
											    req.open('GET', "dirExists.php?path="+path+"/"+(prevFound+1), false); //i.e. Heroes/0/ (Red)
											    req.onreadystatechange = function(){
											    	trainerGens[char][trainerTotal] = [];
										    		for(var j=0; j<trainerGenPaths.length; j++){
										    			var _req = new XMLHttpRequest();
													    _req.open('GET', "dirExists.php?path="+path+"/"+prevFound+"/"+trainerGenPaths[j], false);
													    _req.onreadystatechange = function(){
													    	if(_req.responseText == 1){
													    		trainerGens[char][trainerTotal].push(j);
													    	}
													    }
													    _req.send();
										    		}
										    		numTrainers[char][i]++;
										    		trainerTotal++;
										    		prevFound++;
											    	
											    	if(req.responseText != 1){
											    		findNext = false;
											    	}
											    };
											    req.send();
											}
											
//											trainerTotal = 0;
											var p = 0;
											for(var j=0; j<i; j++){
												p += numTrainers[char][j];
											}
											
											for(var j=0; j<numTrainers[char][i]; j++){
												var img = new Image();
												img.src = (p+j)==0 ? "GUI/del.png" : path+"/"+j+"/"+trainerGenPaths[trainerGens[char][p+j][trainerGens[char][p+j].length-1]]+"/0.png";
												img.onload = (function(img, j, p){
													return function(){
														createTrainerIcon(img, ctx_selector, j+p, false, false, 'selector', setTrainer(j+p, trainerGens[char][p+j][trainerGens[char][p+j].length-1], 0, (p+j)!=0));
													}
												})(img, j, p);
//												trainerTotal++;
											}
										}
									//}
									break;
					
					
					case 'pokemon':	for(var i=0; i<iconColumns[1]*iconRows[1]; i++){
										var n = i + iconColumns[1]*iconRows[1]*context.pokemonpage;
										var img = new Image();
										img.src = n==0 ? "GUI/del.png" : "pokemon/heartgold-soulsilver/"+n+".png";
										img.onload = (function(img, i, n){
											return function(){
												var x = iconX + (i%iconColumns[1])*iconSizes[1];
												var y = iconY + Math.floor(i/iconColumns[1])*iconSizes[1];
												
//												ctx.clearRect(c_selector.x, c_selector.y, c_selector.width, c_selector.height);
												ctx_selector.drawImage(img, x, y, iconSizes[1], iconSizes[1]);
												ctx_selector.drawToContext(ctx, true);
					//							ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
												bounds["pokemon"+i] = new Bounds(x+c_selector.x, y+c_selector.y, iconSizes[1], iconSizes[1], 'selector', setPokemon(n, 11, n!=0)); //11 = HGSS sprites
											}
										})(img, i, n);
									}
									break;
				}
				
				for(var i=0; i<tabs.length; i++){
					tabs[i].draw();
				}
				for(var i=0; i<pageButtons.length; i++){
					pageButtons[i].draw();
				}
				for(var i=0; i<buttons.length; i++){
					buttons[i].draw();
				}
			}
			
			function getSizes(img, max){
				if(img.width > max || img.height > max){
					var fac = img.width > img.height ? max/img.width : max/img.height;
					return [Math.round(img.width*fac), Math.round(img.height*fac)];
				}
				return [img.width, img.height];
			}
			
			function createTrainerIcon(img, gctx, i, showPlus, addPos, region, callback, update){ //addPos is for showing "back" button in front e.g.
				var size = getSizes(img, 80);
				var corrX = Math.round((80-size[0])*0.5);
				var corrY = Math.round((80-size[1])*0.5);
				
				var extra = addPos?1:0;
				var x = 0;
				var y = 0;

				if(region == 'selector'){
					x += ((i+extra)%iconColumns[0])*80 + corrX + iconX;
					y += Math.floor((i+extra)/iconColumns[0])*80 + corrY + iconY;
				}
				else{
					x += ((i+extra)%editorColumns[0])*80 + corrX + editorX;
					y += Math.floor((i+extra)/editorColumns[0])*80 + corrY + editorY;
				}				
				gctx.drawImage(img, x, y, size[0], size[1]);
//				gctx.strokeRect(x-corrX, y-corrY, 80, 80);
				gctx.drawToContext(ctx, true);
//				alert(update);
				var boundsName = region == 'selector' ? "trainer" : "editor";
				if(update != undefined){
					bounds[boundsName+i] = new Bounds(x+gctx.canvas.x-corrX, y+gctx.canvas.y-corrY, 80, 80, region, callback, update);
				}
				else{
					bounds[boundsName+i] = new Bounds(x+gctx.canvas.x-corrX, y+gctx.canvas.y-corrY, 80, 80, region, callback);
				}
				
				if(showPlus){
					var i_sil = new Image();
		    		i_sil.src = "GUI/silhouette.png";
		    		i_sil.onload = function(){
		    			ctx_editor.drawImage(i_sil, Math.round(x+80-(80-img.width)*0.5)-i_sil.width, y-corrY);
		    			ctx_editor.drawToContext(ctx, true);
		    		}
				}
			}
			
			function updateEditor(numEntity, updateSection, content, contentParam){ //updateSection = 0: buttons only, 1: content only, 2: both
																	  //context = 'gens'/'frames'
				var clearHeight = 50;
				
				if(updateSection == 0){
					ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, clearHeight);
					ctx_editor.clearRect(0, 0, c_editor.width, clearHeight);
					
					for(var i=0; i<genderButtons.length; i++){
						genderButtons[i].draw();
					}
					shinyButton.draw();
					return;
				}
				else if(updateSection == 1){
					ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y + clearHeight, c_editor.width, c_editor.height - clearHeight);
					ctx_editor.clearRect(0, clearHeight, c_editor.width, c_editor.height - clearHeight);
				}
				else if(updateSection == 2){
					ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, c_editor.height);
					ctx_editor.clearRect(0, 0, c_editor.width, c_editor.height);
					
					if(context.sub == 'pokemon'){
						for(var i=0; i<genderButtons.length; i++){
							genderButtons[i].draw();
						}
						shinyButton.draw();
					}
				}
				
				for(var key in bounds){
					if(key.startsWith("editor")){
						delete bounds[key];
					}
				}
				
				ctx_editor.drawRoundedRect(sectionLineWidth, sectionLineWidth+50, c_editor.width-8, c_editor.height-58, 6, sectionFill, sectionStroke, sectionLineWidth);

				var spritesFound = 0;
				
				switch(context.sub){
//					case 'trainer':		if(bounds['setEditorMale']){
//											bounds['setEditorMale'].ac = false;
//											bounds['setEditorFemale'].ac = false;
//											bounds['setEditorShiny'].ac = false;
//										}
//										
//										for(var i=0; i<8; i++){ //8 = maxSprites
//											var path = "characters/trainers/"+numEntity+"/"+i+".png";
//											var req = new XMLHttpRequest();
//										    req.open('GET', "fileExists.php?path="+path, false);
//										    req.onreadystatechange = function(){
//										    	if(req.responseText != 1){
//										    		return;
//										    	}
//										    	var img = new Image();
//												img.src = path;
//												img.onload = (function(img, i, numEntity, pos){
//													return function(){
//														var x = editorX + (pos%editorColumns[0])*iconSizes[0];
//														var y = editorY + Math.floor(pos/editorColumns[0])*iconSizes[0];
//														
////														ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, c_editor.height);
//														ctx_editor.drawImage(img, x, y, iconSizes[0], iconSizes[0]);
//														ctx_editor.drawToContext(ctx, true);
////														alert(pos+" - "+editorColumns);
//							//							ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
//														bounds["editor"+i] = new Bounds(x+c_editor.x, y+c_editor.y, iconSizes[0], iconSizes[0], 'editor', setTrainer(numEntity, i, false));
//													}
//												})(img, i, numEntity, spritesFound);
//										    	spritesFound++;
//										    };
//										    req.send();
//										}
//										break;
					
					case 'trainer':		if(bounds['setEditorMale']){
											bounds['setEditorMale'].ac = false;
											bounds['setEditorFemale'].ac = false;
											bounds['setEditorShiny'].ac = false;
										}
										
										var path = "characters/trainers/"+(context.main == 'self' ? "back" : "front")+"/";
										var prevTrainers = 0;
										var char = context.main == 'self' ? 0 : 1;
										if(numEntity > 0){
											for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", ...]
												if(numEntity < numTrainers[char][i] + prevTrainers){
													path += trainerPaths[i] + "/" + (numEntity - prevTrainers); //path is now .../front/Heroes/1 e.g.
												}
												else{
													prevTrainers += numTrainers[char][i];
												}
											}
										}
										
										if(content == 'gens'){
											//for(tg trainerGen in trainerGens) --> display(tg[0])
//											alert(trainerGens[char]);
											for(var i=0; i<trainerGens[char][numEntity].length; i++){
												var img = new Image();
												img.src = path+"/"+trainerGenPaths[trainerGens[char][numEntity][i]]+"/0.png";
												img.onload = (function(img, i, numEntity){
													return function(){
														var req = new XMLHttpRequest();
													    req.open('GET', "fileExists.php?path="+path+"/"+trainerGenPaths[trainerGens[char][numEntity][i]]+"/1.png", false); //if true, multiple frames exist; add callback by abusing Bounds.update();
													    req.onreadystatechange = function(){
													    	if(req.responseText == 1){
													    		createTrainerIcon(img, ctx_editor, i, true, false, 'editor', setTrainer(numEntity, trainerGens[char][numEntity][i], 0, false), new function(){return function(){updateEditor(numEntity, updateSection, 'frames', i);}});
													    	}
													    	else{
													    		createTrainerIcon(img, ctx_editor, i, false, false, 'editor', setTrainer(numEntity, trainerGens[char][numEntity][i], 0, false));
													    	}
													    };
													    req.send();
													}
												})(img, i, numEntity);
											}
										}
										
										else if(content == 'frames'){
											var path = "characters/trainers/"+(context.main == 'self' ? "back" : "front")+"/";
											
											for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", ...]
												if(numEntity < numTrainers[char][i] + prevTrainers){
													path += trainerPaths[i] + "/" + (numEntity - prevTrainers); //path is now .../front/Heroes/1 e.g.
												}
												else{
													prevTrainers += numTrainers[char][i];
												}
											}
											
											var numFrames = 2; //0.png and 1.png confirmed already
											var findNext = true;
											
											while(findNext){
												var req = new XMLHttpRequest();
//												alert(contentParam);
												req.open('GET', "fileExists.php?path="+path+"/"+trainerGenPaths[trainerGens[char][numEntity][contentParam]]+"/"+numFrames+".png", false);
											    req.onreadystatechange = function(){
											    	if(req.responseText == 1){
											    		numFrames++;
											    	}
											    	else{
											    		findNext = false;
											    	}
											    };
											    req.send();
											}
											
											for(var i=-1; i<numFrames; i++){
												var img = new Image();
												img.src = i == -1 ? "GUI/btn_back.png" : path+"/"+trainerGenPaths[trainerGens[char][numEntity][contentParam]]+"/"+i+".png";
												img.onload = (function(img, i, numEntity){
													return function(){
														if(i == -1){
															createTrainerIcon(img, ctx_editor, i, false, true, 'editor', new function(){return function(){updateEditor(numEntity, updateSection, 'gens')}});
														}
														else{
															createTrainerIcon(img, ctx_editor, i, false, true, 'editor', setTrainer(numEntity, trainerGens[char][numEntity][contentParam], i, false));
														}
														
//														if(i == -1){
//															bounds["editor"+i] = new Bounds(x+c_editor.x-corrX, y+c_editor.y-corrY, iconSizes[0], iconSizes[0], 'editor', new function(){return function(){updateEditor(numEntity, updateSection, 'gens')}});
//														}
//														else{
//															bounds["editor"+i] = new Bounds(x+c_editor.x-corrX, y+c_editor.y-corrY, iconSizes[0], iconSizes[0], 'editor', setTrainer(numEntity, trainerGens[char][numEntity][contentParam], i, false));
//														}
												    };
												    req.send();
												})(img, i, numEntity);
											}
										}
										
										break;
										
//										for(var i=0; i<8; i++){ //8 = maxSprites
//											var req = new XMLHttpRequest();
//										    req.open('GET', "fileExists.php?path="+path+"/"+i, false);
//										    req.onreadystatechange = function(){
//										    	if(req.responseText != 1){
//										    		return;
//										    	}
//										    	var img = new Image();
//												img.src = path;
//												img.onload = (function(img, i, numEntity, pos){
//													return function(){
//														var x = editorX + (pos%editorColumns[0])*iconSizes[0];
//														var y = editorY + Math.floor(pos/editorColumns[0])*iconSizes[0];
//														
////														ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, c_editor.height);
//														ctx_editor.drawImage(img, x, y, iconSizes[0], iconSizes[0]);
//														ctx_editor.drawToContext(ctx, true);
////														alert(pos+" - "+editorColumns);
//							//							ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
//														bounds["editor"+i] = new Bounds(x+c_editor.x, y+c_editor.y, iconSizes[0], iconSizes[0], 'editor', setTrainer(numEntity, i, false));
//													}
//												})(img, i, numEntity, spritesFound);
//										    	spritesFound++;
//										    };
//										    req.send();
//										}
					
					case 'pokemon':		if(bounds['setEditorMale']){
											bounds['setEditorMale'].ac = true;
											bounds['setEditorFemale'].ac = true;
											bounds['setEditorShiny'].ac = true;
										}
										
										for(var i=0; i<genPaths.length; i++){
											var path = "pokemon/"+genPaths[i]+"/"+numEntity+".png";
											var req = new XMLHttpRequest();
										    req.open('GET', "fileExists.php?path="+path, false);
										    req.onreadystatechange = function(){
										    	if(req.responseText != 1){
										    		return;
										    	}
										    	var img = new Image();
												img.src = path;
												img.onload = (function(img, i, numEntity, pos){
													return function(){
														var x = editorX + (pos%editorColumns[1])*iconSizes[1];
														var y = editorY + Math.floor(pos/editorColumns[1])*iconSizes[1];
														
//														ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, c_editor.height);
														ctx_editor.drawImage(img, x, y, iconSizes[1], iconSizes[1]);
														ctx_editor.drawToContext(ctx, true);
							//							ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
														bounds["editor"+i] = new Bounds(x+c_editor.x, y+c_editor.y, iconSizes[1], iconSizes[1], 'editor', setPokemon(numEntity, i, false));
													}
												})(img, i, numEntity, spritesFound);
										    	spritesFound++;
										    };
										    req.send();
										}
										break;
				}
			}
			
			var setContext = function(cat, val, pokemonNum){
				return function(){
					switch(cat){
						case 'main':		context.main = val;
											if(context.sub == 'trainer'){
												updateSelector();
											}
											break;
						case 'sub':			var oldSub = context.sub;
											context.sub = val;
											if(oldSub != context.sub){
												updateSelector();
											}
											break;
						case 'pokemonpage':	var oldPage = context.pokemonpage;
											context.pokemonpage = Math.max(0, Math.min(context.pokemonpage+val, 4));
											if(oldPage != context.pokemonpage){
												updateSelector();
											}
											break;
						case 'zoom':		var oldZoom = context.zoomLevel;
											context.zoomLevel = val;
											if(oldZoom != context.zoomLevel){
//												ctx.clearRect(0, 0, renderSizes[oldZoom][0], renderSizes[oldZoom][1]);
												ctx.clearRect(0, 0, 2000, 1000);
												if(context.zoomLevel == 2){
													ctx.canvas.width = 1350;
													ctx.canvas.height = 600;
												}
												else{
													ctx.canvas.width = 1200;
													ctx.canvas.height = 570;
												}
												var offsetX = renderSizes[context.zoomLevel][0] - renderSizes[oldZoom][0];
												var offsetY = renderSizes[context.zoomLevel][1] - renderSizes[oldZoom][1];
												
												c_selector.x += offsetX;
												c_editor.x += offsetX;
												c_displayPanel.y += offsetY;
												
												ctx_selector.drawToContext(ctx, true);
												ctx_editor.drawToContext(ctx, true);
												ctx_displayPanel.drawToContext(ctx, true);
												
												for(var key in bounds){
													if(bounds[key].section == 'zoom'){
														bounds[key].y += offsetY;
													}
													else{
														bounds[key].x += offsetX;
													}
												}
												
												var textY = parseInt(document.getElementById('BattleTextDiv').style.top);
												document.getElementById('BattleTextDiv').style.top = (textY + offsetY)+"px";
												
//												alert(document.getElementById('battleText').style.width);
												var textBoxW = parseInt(document.getElementById('battleText').style.width);
												document.getElementById('battleText').style.width = (textBoxW + offsetX)+"px";
												
//												var fs = "12px";
//												if(context.zoomLevel == 1){
//													fs = "18px";
//												}
//												else if(context.zoomLevel == 2){
//													fs = "24px";
//												}
//												document.getElementById('battleText').style.fontSize = fs;
												
												updateImage();
											}
											break;
					}
					
					if(pokemonNum != undefined){
						context.pokemonNum = pokemonNum;
					}
				}
			};
			
			var saveImage = function(method){
				return function(){
					switch(method){
						case 'file':	//form = document.getElementById('saveForm');
//										form.elements[0].value = encodeURI(c_image.toDataURL());
//										form.submit();
										
										var form = document.createElement('form');
										form.method = 'post';
										form.action="saveImage.php";
										form.target="_blank";
										
										var p = document.createElement('input')
										p.type = 'hidden';
										p.name = "path";
										p.value = encodeURI(c_image.toDataURL());
										
										document.body.appendChild(form);
										form.appendChild(p);
										form.submit();
										
										break;
					}
				}
			}
			
			var context = {main: 'self', sub:'trainer', pokemonNum:0, pokemonpage:0, environment:0, time:0, zoomLevel:0};
			
			var sectionLineWidth = 3;
			var sectionFill = "rgba(255, 255, 255, 0.5)";
			var sectionStroke = "rgba(0, 0, 0, 1)";
			
			var setBtnX = sectionLineWidth+10;//600;
			var setBtnY = sectionLineWidth+6;//10;
			var setBtnSh = 105; //spacing horizontal
			var setBtnSv = 30; //spacing vertical
			
			var zoomBtnX = 0;
			var zoomBtnY = 0;//250;
			var zoomBtnSh = 75; //spacing horizontal
			
			var saveBtnX = 0;
			var saveBtnY = 50;//250;
			var saveBtnSv = 45; //spacing horizontal
			
			var genderBtnX = 0;
			var shinyBtnX = 100;
			var characteristicsBtnY = 10;
			
//			var bounds = {"setTrainerSelf": new Bounds(400, 50, 100, 50, drawPokemon, 492),
//							};
			var bounds = {};
			var tabs = [];
			var buttons = [];
			var zoomButtons = [];
			var pageButtons = [];
			var genderButtons = [];
			var shinyButton;
//			var trainerSelf, pokemonSelf1, pokemonSelf2, pokemonSelf3, trainerOpp, pokemonOpp1, pokemonOpp2, pokemonOpp3; //sprites
			var trainers = [];
			var pokemon = [[], []]; //[[self1, self2, self3], [opp1, opp2, opp3]]
			var environment = [[], [], []];
			var bases = [[]]; //front, back
			var textBoxes = [];
			var genPaths = ["red-green", "red-blue", "yellow", "gold", "silver", "crystal", "ruby-sapphire", //"emerald",
							"firered-leafgreen", "diamond-pearl", "platinum", "heartgold-soulsilver", "black-white"];
			
			var genBoxes = ["GUI/genbox_RG.png", "GUI/genbox_RB.png", "GUI/genbox_Y.png", "GUI/genbox_G.png",
							"GUI/genbox_S.png", "GUI/genbox_C.png", "GUI/genbox_RSE.png", "GUI/genbox_FRLG.png",
							"GUI/genbox_DP.png", "GUI/genbox_P.png", "GUI/genbox_HGSS.png", "GUI/genbox_BW.png"];
			
			var trainerPaths = ["Heroes", "Friends"];
			var trainerGenPaths = ["rgb", "yellow", "gsc", "rs", "emerald", "frlg", "dp", "platinum", "hgss", "bw", "bw2"];
			
			var numTrainers = [[], []];
			var trainerGens = [[], []];
			
			for(var i=0; i<trainerPaths.length; i++){
				numTrainers[0][i] = numTrainers[1][i] = 0;
			}
					
			var renderSizes = [[256, 190], [384, 285], [512, 380]];
//			var smallPokemon = [1,2,4,5,7,8,10,11,13,14,16,19,20,21,23,27,28,29,32,35,37,39,43,44,46];
			
			var c = document.getElementById("myCanvas");
			var ctx = c.getContext("2d");
			
			var spriteSize = 80;
			
			var posPokemon = [[[[32, 152]],  [[0, 152], [40, 164]],  [[0, 152], [40, 158], [86, 164]]],
							  [[[40, 0]],  [[20, 0], [60, 0]],  [[0, 0], [40, 0], [80, 0]]],
							  [[[150, 10]],  [[136, 4], [175, 15]],  [[126, 4], [145, 15], [185, 14]]]];
							  //[[single], [double1, double2], [triple1, triple2, triple3]]	x3 (self gen1-12, self gen13, opp) char, singdoubtrip, pos, x/y
			var trainerPos = [[0, 64], [185, 88]];
			
//			var iconX = sectionLineWidth*2;//600;
			var iconY = sectionLineWidth*2 + 66;
			var iconColumns = [5, 10];
			var iconRows = [5, 11];
			var iconSizes = [80, 40];
			var pageOffsetX = 70;
			
			var editorX = sectionLineWidth*2;//300;
			var editorY = sectionLineWidth*2 + 50;//70;
			var editorColumns = [3, 6];
			var editorRows = [3, 3];
			
			environment[0][0] = new Image();
			environment[0][0].src = "environment/grassland/day.png";
//			environment[0][0].onload = function(){updateImage();};
			
			bases[0][0] = new Image();
			bases[0][0].src = "environment/grassland/base_front.png";
//			bases[0][0].onload = function(){updateImage();};
			
			bases[0][1] = new Image();
			bases[0][1].src = "environment/grassland/base_back.png";
//			bases[0][1].onload = function(){updateImage();};
			
			var c_image = document.createElement('canvas');
			c_image.width = 256;
			c_image.height = 190;
			var ctx_image = c_image.getContext('2d');
			
			var c_selector = document.createElement('canvas');
			c_selector.x = 600;
			c_selector.y = 10;
			c_selector.width = 440;
			c_selector.height = 560;
			var ctx_selector = c_selector.getContext('2d');
			
			var c_editor = document.createElement('canvas');
			c_editor.x = 300;
			c_editor.y = 70;
			c_editor.width = 253;
			c_editor.height = 302;
			var ctx_editor = c_editor.getContext('2d');

			var c_displayPanel = document.createElement('canvas');
			c_displayPanel.x = 0;
			c_displayPanel.y = 250;
			c_displayPanel.width = 255;
			c_displayPanel.height = 140;
			var ctx_displayPanel = c_displayPanel.getContext('2d');
						
			var c_textBoxes = document.createElement('canvas');
			var ctx_textBoxes = c_textBoxes.getContext('2d');
			var i_textBoxes = new Image();
			i_textBoxes.src = "GUI/textBoxes_HGSS.png";
			i_textBoxes.onload = function(){
				c_textBoxes.width = i_textBoxes.width;
				c_textBoxes.height = i_textBoxes.height;
				ctx_textBoxes.drawImage(i_textBoxes, 0, 0);
				textBoxes[0] = ctx_textBoxes.getImageData(0, 0, 256, 46);
				updateImage();
			};
			
			var iconX = (c_selector.width - iconSizes[1]*iconColumns[1]) * 0.5;
			
			ctx.clearRect(0, 0, c.width, c.height);
			
			pageButtons[0] = new Button("setNextPage", "GUI/next", iconX + iconColumns[1]*iconSizes[1]*0.5 + pageOffsetX, iconY + iconRows[1]*iconSizes[1],
										false, ctx_selector, 'editor', setContext('pokemonpage', 1));
			pageButtons[1] = new Button("setPrevPage", "GUI/prev", iconX + iconColumns[1]*iconSizes[1]*0.5 - pageOffsetX - iconSizes[1],
										iconY + iconRows[1]*iconSizes[1], false, ctx_selector, 'editor', setContext('pokemonpage', -1));
			
			new Button("setSaveImageFile", "GUI/btn_save", saveBtnX, saveBtnY, false, ctx_displayPanel, 'zoom', saveImage('file'));
			new Button("setSaveImageMail", "GUI/btn_mail", saveBtnX, saveBtnY+saveBtnSv, false, ctx_displayPanel, 'zoom', saveImage('mail'));
			
			tabs[0] = new Button("setSelf", "GUI/tab_self", setBtnX, setBtnY, true, ctx_selector, 'editor', setContext('main', 'self'),
								 updateUI('tabs', 0), true);
			tabs[1] = new Button("setOpp", "GUI/tab_opponent", setBtnX+100, setBtnY, true, ctx_selector, 'editor', setContext('main', 'opp'),
								 updateUI('tabs', 1));
			
			buttons[0] = new Button("setTrainer", "GUI/btn_blue_trainer", setBtnX, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'trainer'), updateUI('buttons', 0), true);
			buttons[1] = new Button("setPokemon1", "GUI/btn_blue_pokemon1", setBtnX+setBtnSh, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'pokemon', 0), updateUI('buttons', 1));
			buttons[2] = new Button("setPokemon2", "GUI/btn_blue_pokemon2", setBtnX+setBtnSh*2, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'pokemon', 1), updateUI('buttons', 2));
			buttons[3] = new Button("setPokemon3", "GUI/btn_blue_pokemon3", setBtnX+setBtnSh*3, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'pokemon', 2), updateUI('buttons', 3));
			
			genderButtons[0] = new Button("setEditorMale", "GUI/btn_male", genderBtnX, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics, updateUI('gender', 0), true, false);
			genderButtons[1] = new Button("setEditorFemale", "GUI/btn_female", genderBtnX+40, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics, updateUI('gender', 1), false, false);
			
			shinyButton = new Button("setEditorShiny", "GUI/btn_shiny", shinyBtnX, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics, updateUI('shiny', 0), false, false);
			
			zoomButtons[0] = new Button("setZoom1", "GUI/btn_zoom_1x", zoomBtnX, zoomBtnY, true, ctx_displayPanel, 'zoom', setContext('zoom', 0),
										updateUI('zoom', 0), true);
			zoomButtons[1] = new Button("setZoom2", "GUI/btn_zoom_1_5x", zoomBtnX+zoomBtnSh, zoomBtnY, true, ctx_displayPanel, 'zoom',
										setContext('zoom', 1), updateUI('zoom', 1), false);
			zoomButtons[2] = new Button("setZoom3", "GUI/btn_zoom_2x", zoomBtnX+zoomBtnSh*2, zoomBtnY, true, ctx_displayPanel, 'zoom',
										setContext('zoom', 2), updateUI('zoom', 2), false);
			
			
			tabs[0].activate();
			buttons[0].activate();
			zoomButtons[0].activate();
			genderButtons[0].activate();
			
			updateSelector();
			
//			ctx.clearRect(c_editor.x, c_editor.y, c_editor.width, c_editor.height); //really, really ugly 'fix'
			
			c.onclick = function(e) {
				for(var key in bounds){
					if((key.startsWith(context.sub) || key.startsWith("set") || key.startsWith("editor")) && bounds[key] && bounds[key].ac &&
					   bounds[key].inBounds(e.clientX - c.getBoundingClientRect().left, e.clientY - c.getBoundingClientRect().top)){
//					   	alert(key);
					   	var exec = bounds[key].execute; //crazy caching due to update()s that can clear bounds
						bounds[key].update();
						exec();
					}
				}
			}
			
			c.onmousemove = function(e) {
				var x = e.clientX - c.getBoundingClientRect().left;
				var y = e.clientY - c.getBoundingClientRect().top;
				var foundSprite = [];
				
				for(var key in bounds){
					if(x > c_editor.x && x < c_editor.x + c_editor.width && y > c_editor.y && y < c_editor.y + c_editor.height &&
					   bounds[key].inBounds(x, y) && context.sub == 'pokemon'){
					   	foundSprite = key.split('editor');
					   	break;
					}
				}
				
				if(foundSprite.length > 0){
//					alert(foundSprite[1]);
					document.getElementById('GenInfoDiv').style.visibility = 'visible';
					document.getElementById('GenInfoDiv').style.left = (x+20)+"px";
					document.getElementById('GenInfoDiv').style.top = (y+20)+"px";
//					alert(document.getElementById('GenInfoDiv').style.background-color);
//					document.getElementById('GenInfoDiv').style.backgroundImage = "url("+genBoxes[foundSprite[1]].src+")";
//					document.getElementById('GenInfoDiv').innerHTML = genPaths[foundSprite[1]];
					document.getElementById('GenInfoDiv').innerHTML = "<img src="+genBoxes[foundSprite[1]]+">";
				}
				else{
					document.getElementById('GenInfoDiv').style.visibility = 'hidden';
				}
			}
      
		</script> 
	</body>
</html>