<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	</head>
	<body>
		<style type="text/css">
			body{
				background-image:url("GUI/diag_lines.png");
				background-repeat:repeat;
			} 
		</style>
	
		<div id="BattleTextDiv" style="position:absolute; top:200px; left:10px; width:250px; height:50px;">
			<textarea id="battleText" rows="2" oninput="updateImage();" style="width: 250px; resize: none; font-size:12px">Trainer X wants to battle!</textarea>
		</div>
		
		<div id="GenInfoDiv" style="position:absolute; top:200px; left:20px; width:50px; height:10px; font-size:7pt; color:#FFF; visibility:hidden; pointer-events:none">
			Some Gen!
		</div>
		
		<canvas id="canvas" width="1200" height="570"></canvas> 

		<script>
			if(typeof String.prototype.startsWith != 'function'){
			  String.prototype.startsWith = function(str){
			    return this.lastIndexOf(str, 0) == 0;
			  };
			}
			
			if(!HTMLCanvasElement.prototype.x){
				HTMLCanvasElement.prototype.x = 0;
			}
			
			if(!HTMLCanvasElement.prototype.y){
				HTMLCanvasElement.prototype.y = 0;
			}
			
			if(!CanvasRenderingContext2D.prototype.drawToContext){
				CanvasRenderingContext2D.prototype.drawToContext = function(c, clearFirst){
					if(clearFirst){
//						alert(c+" - "+this.x);
						c.clearRect(this.canvas.x, this.canvas.y, this.canvas.width, this.canvas.height);
					}
					c.drawImage(this.canvas, this.canvas.x, this.canvas.y);
			  };
			}
			
			//Major thanks for Michael Jackson (@mjackson) for this one!
			function hsvToRgb(h, s, v){
			    var r, g, b;
			
			    var i = Math.floor(h * 6);
			    var f = h * 6 - i;
			    var p = v * (1 - s);
			    var q = v * (1 - f * s);
			    var t = v * (1 - (1 - f) * s);
			
			    switch(i % 6){
			        case 0: r = v, g = t, b = p; break;
			        case 1: r = q, g = v, b = p; break;
			        case 2: r = p, g = v, b = t; break;
			        case 3: r = p, g = q, b = v; break;
			        case 4: r = t, g = p, b = v; break;
			        case 5: r = v, g = p, b = q; break;
			    }
			
			    return [r * 255, g * 255, b * 255];
			}
			
			if(!CanvasRenderingContext2D.prototype.drawRoundedRect){
				CanvasRenderingContext2D.prototype.drawRoundedRect = function(x, y, width, height, radius, fill, stroke, lineWidth){
					this.beginPath();
					this.moveTo(x + radius, y);
					this.lineTo(x + width - radius, y);
					this.quadraticCurveTo(x + width, y, x + width, y + radius);
					this.lineTo(x + width, y + height - radius);
					this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
					this.lineTo(x + radius, y + height);
					this.quadraticCurveTo(x, y + height, x, y + height - radius);
					this.lineTo(x, y + radius);
					this.quadraticCurveTo(x, y, x + radius, y);
					this.closePath();
					
					if(fill != undefined){
//						alert(this);
						this.fillStyle = fill;
						this.fill();
					}
					
					if(stroke != undefined){
						this.strokeStyle = stroke;
						this.lineWidth = lineWidth;
						this.stroke();
					}        
				}
			}
						
			function Bounds(x, y, w, h, section, execute, update, ac){
				this.x = x;
				this.y = y;
				this.w = w;
				this.h = h;
				this.section = section;
				this.execute = execute;
				this.ac = (ac==undefined) ? true : ac;
				if(update){
					this.update = update;
				}
				else{
					this.update = function(){}; //empty function; kinda ugly?
				}
				this.inBounds = function(x, y){
					return x >= this.x && x <= this.x + this.w && y >= this.y && y <= this.y + this.h;
				}
			}
			
			function Button(name, img_src, x, y, hasActive, gctx, section, execute, update, activatedOnStart, ac){
				this.name = name;
				this.x = x;
				this.y = y;
				this.gctx = gctx;
				this.enabled = false;
				
				var _ac = (ac==undefined) ? true : ac;
				
				if(hasActive){
					var btn_enabled = new Image();
					btn_enabled.src = img_src+"_active.png";
				}
				var btn_disabled = new Image();
				btn_disabled.src = img_src+".png";
				btn_disabled.onload = function(){
					if(!activatedOnStart && _ac){ //abuse ac for first-time drawing
						gctx.drawImage(btn_disabled, x, y);
						gctx.drawToContext(ctx, true);
					}
					bounds[name] = new Bounds(x + gctx.canvas.x, y + gctx.canvas.y, btn_disabled.width, btn_disabled.height, section, execute, update, _ac);
				}
				
				this.activate = function(){
					if(bounds[this.name] && bounds[this.name].ac){
						if(btn_enabled){
							gctx.drawImage(btn_enabled, x, y);
							gctx.drawToContext(ctx, true);
							this.enabled = true;
						}
						else{
							btn_enabled.onload = function(){
								gctx.drawImage(btn_enabled, x, y);
								gctx.drawToContext(ctx, true);
								this.enabled = true;
							}
						}
					}
				}
				
				this.deactivate = function(){
					gctx.drawImage(btn_disabled, x, y);
					gctx.drawToContext(ctx, true);
					this.enabled = false;
				}
				
				this.toggle = function(){
					this.enabled = !this.enabled;
					gctx.drawImage(this.enabled ? btn_enabled : btn_disabled, x, y);
					gctx.drawToContext(ctx, true);
				}
				
				this.draw = function(){ //sometimes a manual redraw is needed
					gctx.drawImage(this.enabled ? btn_enabled : btn_disabled, x, y);
					gctx.drawToContext(ctx, true);
				}
			}
			
			function Sprite(img, x, y, offsetY, num, gen){
				this.img = img;
				this.x = x;
				this.y = y;
				this.offsetY = offsetY;
				this.num = num;
				this.gen = gen;
			}
			
			var updateUI = function(menu, active){
				return function(){
					var set;
					switch(menu){
						case 'tabs':				set = tabs;							break;
						case 'characterButtons':	set = characterButtons;				break;
						case 'sceneButtons':		set = sceneButtons;					break;
						case 'uiButtons':			set = uiButtons;					break;
						case 'gender':				set = genderButtons;				break;
						case 'shiny':				shinyButton.toggle();	return;		break;
						case 'flying':				flyingButton.toggle();	return;		break;
						case 'zoom':				set = zoomButtons;					break;
					}
					
					for(var i=0; i<set.length; i++){
						if(i == active){
							set[i].activate();
						}
						else{
							set[i].deactivate();
						}
					}
				}
			}
			
			var setPokemon = function(numPokemon, gen, redrawEditor){
				return function(){
					if(numPokemon.toString().split("-")[0] != context.pokemon.toString().split("-")[0] || gen != context.pokemonGen){
//						alert(numPokemon +" -> "+ context.pokemon + " -- " + gen + " -> " + context.pokemonGen);
						context.editorpage = 0;
						context.trainer = -1; //looks weird, but disables editor page buttons
						context.pokemon = numPokemon;
						context.pokemonGen = gen;
						context.editorstate = 'pokemon';
					}
					
					
					if(numPokemon == 0){ //remove
						updatePokemon(context.main == 'self' ? 0 : 1, undefined);
						updateImage();
					}
					else{
						var curPokemon = pokemon[context.main == 'self' ? 0 : 1][context.pokemonNum];
						if(curPokemon && curPokemon.num == numPokemon && curPokemon.gen == gen){
							return;
						}
						var i_pokemon = new Image();
						i_pokemon.src = getPokemonImagePath(numPokemon, gen)//"pokemon/"+genPaths[gen]+"/"+numPokemon+".png";
						i_pokemon.onload = function(){
							var c_sprite = document.createElement('canvas');
							c_sprite.width = c_sprite.height = spriteSize;
							var ctx_sprite = c_sprite.getContext('2d');
							ctx_sprite.drawImage(i_pokemon, 0, 0);
							var imgData = ctx_sprite.getImageData(0, 0, spriteSize, spriteSize).data;
							
							var topRow = -1;
							for(var i=0; i<spriteSize; i++){ //scan every row of pixels (line)
								var colorFound = false;
								for(var p=0; p<spriteSize*4; p+=8){ //check every 2 pixels;
									if(imgData[i*spriteSize*4 + p + 3] != 0){ //+3 = alpha channel
										colorFound = true;
										if(topRow == -1){
											topRow = i;
										}
										break;
									}
								}
								if((!colorFound || i==spriteSize-1) && topRow != -1 && i-topRow > 10){
									if(context.main == 'self'){
										if(gen < 12){
											var genCorrection = 0;
											if(gen < 3){
												genCorrection = 8;
											}
											updatePokemon(0, new Sprite(i_pokemon, 0, 0, -(i+genCorrection), numPokemon, gen));
										}
										else{
											updatePokemon(0, new Sprite(i_pokemon, 0, 0, 0, numPokemon, gen));
										}
									}
									else{
										var sizeCorrection = Math.max(0, (Math.min(70, i-topRow)-35)/35) * 8; //Remap to 35-70 --> 0-21
										var weightedFloorLevel = parseInt(spriteSize-i + sizeCorrection);
										updatePokemon(1, new Sprite(i_pokemon, 0, 0, weightedFloorLevel, numPokemon, gen));
									}
									updateImage();
									if(redrawEditor){
										updateEditor(numPokemon, 2, 'gens', false);
									}
									break;
								}
							}
						}
					}
				}
			};
			
			var setTrainer = function(numTrainer, gen, pose, redrawEditor, showTrainerPages){
				return function(){
					var char = context.main == 'self' ? 0 : 1;
					if(context.trainer != numTrainer || context.trainerGen != gen){
						context.editorpage = 0;
						context.trainer = numTrainer;
					}
					if(showTrainerPages){
						context.maxeditorpage = Math.max(0, Math.floor(numTrainerFrames[char][numTrainer][trainerGens[char][numTrainer].indexOf(gen)]/6));
					}
					context.trainerGen = gen
					//*1
					if(numTrainer == -1){ //remove
//					alert("-1");
						trainers[char] = undefined;
						updateImage();
					}
					else{
						context.editorstate = 'trainer'; //Was at *1
						var path = "characters/trainers/"+(char == 0 ? "back" : "front")+"/";
						var prevTrainers = 0;
						for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", ...]
							if(numTrainer < numTrainers[char][i] + prevTrainers){
								path += trainerPaths[i]+"/"+(numTrainer - prevTrainers)+"/"+gen; //path is now /front/Heroes/1/rgb e.g.
								break;
							}
							else{
								prevTrainers += numTrainers[char][i];
							}
						}
						
						var i_trainer = new Image();
						i_trainer.src = path+"/"+pose+".png";
						i_trainer.onload = function(){
							var corrX = 0;//char == 0 ? 0 : -i_trainer.width*0.75;//Math.round((Math.max(96, i_trainer.width) - i_trainer.width)*0.5);
							var corrY = 0;//Math.round((96 - i_trainer.height)*0.5);
							
							if(char == 1){
								var c_sprite = document.createElement('canvas');
								c_sprite.width = i_trainer.width;
								c_sprite.height = i_trainer.height;
								var ctx_sprite = c_sprite.getContext('2d');
								ctx_sprite.drawImage(i_trainer, 0, 0);
								var imgData = ctx_sprite.getImageData(0, 0, i_trainer.width, i_trainer.height).data;
								
								for(var i=i_trainer.width-1; i>0; i--){ //scan every column of pixels (vertical)
									var colorFound = false;
									for(var p=0; p<i_trainer.height*i_trainer.width*4; p+=i_trainer.width*4*2){ //check every 2 pixels
										if(imgData[i*4 + p + 3] != 0){ //+3 = alpha channel
											colorFound = true;
											corrX = -i;
//											alert(i);
											break;
										}
									}
									if(colorFound){
										break;
									}
								}
								
								for(var i=i_trainer.height-1; i>0; i--){ //scan every row of pixels (line)
									var colorFound = false;
									for(var p=0; p<i_trainer.width*4; p+=16){ //check every 4 pixels;
										if(imgData[i*i_trainer.width*4 + p + 3] != 0){ //+3 = alpha channel
											colorFound = true;
											corrY = -i;
//											alert(i+" - "+imgData);
											break;
										}
									}
									if(colorFound){
										break;
									}
								}
							}
							else{
								corrY = 80 - i_trainer.height;
							}
//							alert(char + " - " + corrX + " - " + corrY);
							trainers[char] = new Sprite(i_trainer, trainerPos[char][0] + corrX, trainerPos[char][1] + corrY, 0, numTrainer, pose);
							updateImage();
						}
					}
					
					if(redrawEditor){
						updateEditor(numTrainer, 2, 'gens', true);
					}
				}	
			}
			
			function updatePokemon(char, sprite){
				if(sprite){
					pokemon[char][context.pokemonNum] = sprite;
				}
				else{
					pokemon[char][context.pokemonNum] = undefined;
				}
				
				var totPokemon = (pokemon[char][0] ? 1 : 0) + (pokemon[char][1] ? 1 : 0) + (pokemon[char][2] ? 1 : 0);
				
				if(totPokemon >= 0){
					var curPos = 0;
					for(var i=0; i<3; i++){
						if(pokemon[char][i]){
							var oldGenCorrection = (context.main == 'self' && pokemon[char][i].gen < 11) ? 0 : 1;
							var coords = posPokemon[char+oldGenCorrection][totPokemon-1][curPos];		//char, singdoubtrip, pos, x/y
							var offsetX = 0; //Gen IV+
							var offsetY = pokemonCharacteristics[char][i][2] ? flyingOffset : 0;
							if(pokemon[char][i].gen < 6){
								offsetX = 20;
							}
							else if(pokemon[char][i].gen < 9){
								offsetX = 8;
							}
							pokemon[char][i] = new Sprite(pokemon[char][i].img, coords[0]+offsetX, coords[1]+pokemon[char][i].offsetY+offsetY,
														  pokemon[char][i].offsetY, pokemon[char][i].num, pokemon[char][i].gen);
							curPos++;
						}
					}
				}
			}
			
			var updateCharacteristics = function(characteristic, val){
				return function(){
					var char = context.main=='self' ? 0 : 1;					
					switch(characteristic){
						case 'gender':	pokemonCharacteristics[char][context.pokemonNum][0] = val;
										break;
						case 'shiny':	pokemonCharacteristics[char][context.pokemonNum][1] = !pokemonCharacteristics[char][context.pokemonNum][1];
										break;
						case 'flying':	pokemonCharacteristics[char][context.pokemonNum][2] = !pokemonCharacteristics[char][context.pokemonNum][2];
										break;
					}
					
					if(!pokemon[char][context.pokemonNum]){
						return;
					}
					
					var num = pokemon[char][context.pokemonNum].num;
					var gen = pokemon[char][context.pokemonNum].gen;
					
					var path = getPokemonImagePath(num, gen);
					
					var i_pokemon = new Image();
					i_pokemon.src = path;
					i_pokemon.onload = function(weightedFloorLevel, num, gen){
						return function(){
							updatePokemon(char, new Sprite(i_pokemon, 0, 0, weightedFloorLevel, num, gen));
							updateImage();
							updateEditor(undefined, 0, false);
						}
					}(pokemon[char][context.pokemonNum].offsetY, num, gen);
				}
			}
			
			function updatePokemonCharacteristicButtons(pokemonNum){
				context.pokemonNum = pokemonNum;
				var char = context.main == 'self' ? 0 : 1;
				bounds[genderButtons[0].name].ac = true;
				bounds[genderButtons[1].name].ac = true;
				bounds[shinyButton.name].ac = true;
				bounds[flyingButton.name].ac = true;
				
				if(pokemonCharacteristics[char][pokemonNum][0]){
					genderButtons[0].deactivate();
					genderButtons[1].activate();
				}
				else{
					genderButtons[0].activate();
					genderButtons[1].deactivate();
				}
				
				if(pokemonCharacteristics[char][pokemonNum][1]){
					shinyButton.activate();
				}
				else{
					shinyButton.deactivate();
				}
				
				if(pokemonCharacteristics[char][pokemonNum][2]){
					flyingButton.activate();
				}
				else{
					flyingButton.deactivate();
				}
			}
			
			function getPokemonImagePath(num, gen){
				var char = 1;
				var path = "pokemon/"+genPaths[gen]+"/";
				
				if(context.main == 'self'){
					char = 0;
					path += "back/";
				}
//				if(document.getElementById('characteristic_shiny').checked && gen > 2){
				if(pokemonCharacteristics[char][context.pokemonNum][1] && gen > 2){//if(shinyButton.enabled && gen > 2){
					path += "shiny/";
				}
//				if(document.getElementById('characteristic_female').checked && gen > 8){
				if(pokemonCharacteristics[char][context.pokemonNum][0] && gen > 8){//if(genderButtons[1].enabled && gen > 8){
					var req = new XMLHttpRequest();
				    req.open('GET', "scripts/fileExists.php?path="+path+"female/"+num+".png", false);
				    req.onreadystatechange = function(){
				    	if(req.responseText == 1){
							path += "female/";
				    	}
				    }
				    req.send();
				}
				path += num+".png";
				return path;
			}
			
			function drawSprite(sprite){
				if(sprite){
					ctx_image.drawImage(sprite.img, sprite.x, sprite.y);
				}
			}
			
			var setTime = function(time){
				return function(){
					context.time = time*0.5;
					updateEditor(0, 2);
					updateImage();
				}
			}
			
			var setBackground = function(numBg){
				return function(){
					if(numBg == -1){
						var i_bg = new Image();
						i_bg.src = "environment/blank_background.png";
						i_bg.onload = function(){
							background = [undefined, i_bg, undefined];
							backgroundReady = true;
							updateImage();
//							updateEditor(0, 2);
						}
					}
					backgroundReady = false;
					var bgsLoaded = 0;
					for(var i=0; i<3; i++){
						if(backgrounds[numBg].indexOf(i+".png") == -1){
							background[i] = undefined;
							bgsLoaded++; //technically incorrect..
							if(bgsLoaded == 3){
								backgroundReady = true;
								updateImage();
								updateEditor(0, 2);
							}
						}
						else{
							var i_bg = new Image();
							i_bg.src = "environment/backgrounds/"+numBg+"/"+i+".png";
							i_bg.onload = function(img, i){
								return function(){
									background[i] = img;
									bgsLoaded++;
									if(bgsLoaded == 3){
										backgroundReady = true;
										updateImage();
										updateEditor(0, 2);
									}
								}
							}(i_bg, i);
						}
					}
				}
			}
			
			function updateImage(){
				var w = renderSizes[context.zoomLevel][0];
				var h = renderSizes[context.zoomLevel][1];
				
				ctx.clearRect(0, 0, w, h); //final image dimensions
				ctx_image.clearRect(0, 0, renderSizes[0][0], renderSizes[0][1]); //final image dimensions
				
				if(backgroundReady){ //assumes there's always a "1.png"
					var bg_front;
					var bg_back;
					var alpha = 1 - context.time*2;
					
					if(context.time < 0.5 && backgrounds[0]){
						bg_front = background[0];
						bg_back = background[1];
					}
					
					else if(context.time > 0.5 && backgrounds[2]){
						bg_back = background[1];
						bg_front = background[2];
						alpha = context.time*2 - 1;
					}
					else{
						bg_back = background[1];
					}
					
					ctx_image.drawImage(bg_back, 0, 0);
					if(bg_front){
						ctx_image.globalAlpha = alpha;
						ctx_image.drawImage(bg_front, 0, 0);
						ctx_image.globalAlpha = 1;
					}
					
//					ctx_image.drawImage(background[0], 0, 0);
				}
//				drawSprite(bases[0]);
//				drawSprite(bases[1]);
				
				if(bases[0].length > 0){ //draw front + back, not tintable
					if(bases[0][0]){
						ctx_image.drawImage(bases[0][0], -42, 117);
					}
					if(bases[0][1]){
						ctx_image.drawImage(bases[0][1], 128, 56);
					}
				}
				else if(basesReady && bases[1][1]){ //assume index 1 always exists
					var base_front;
					var base_back;
					var alpha = 1 - context.time*2;
					
					if(context.time < 0.5 && bases[1][0]){
						base_front = bases[1][0];
						base_back = bases[1][1];
					}
					
					else if(context.time >= 0.5 && bases[1][2]){
						base_back = bases[1][1];
						base_front = bases[1][2];
						alpha = context.time*2 - 1;
					}
					else{
						base_back = bases[1][1];
					}
					
					ctx_image.drawImage(base_back, 0, 0);
					if(base_front){
						ctx_image.globalAlpha = alpha;
						ctx_image.drawImage(base_front, 0, 0);
						ctx_image.globalAlpha = 1;
					}
				}
				
				var numPokemon = 0; //self
				for(var i=0; i<3; i++){
					if(pokemon[0][i]){
						numPokemon++;
					}
				}
//				alert(numPokemon);
				
				if(numPokemon < 3){
					drawSprite(pokemon[0][0]);
					drawSprite(pokemon[0][1]);
					drawSprite(pokemon[0][2]);
				}
				else{
					drawSprite(pokemon[0][1]);
					drawSprite(pokemon[0][0]);
					drawSprite(pokemon[0][2]);
				}
				
				drawSprite(trainers[0]);
				
				drawSprite(trainers[1]);
				drawSprite(pokemon[1][0]);
				drawSprite(pokemon[1][2]);
				drawSprite(pokemon[1][1]);
				
				updateTextArea();
				
				ctx.drawImage(c_image, 0, 0, w, h);
			}
			
			function updateTextArea(){
				ctx_image.clearRect(0, 144, 256, 48);
				ctx_image.fillStyle = "rgba("+textBoxColor[0]+","+textBoxColor[1]+","+textBoxColor[2]+","+textBoxColor[3]+")";

				ctx_image.fillRect(0, 144, 256, 48);
				
				if(textBox != undefined){
					ctx_image.drawImage(textBox, 0, 144);
					
					var battleText = document.getElementById("battleText").value;
					if(battleText){
						setText(battleText, ctx_image, 17, 154, 220, 30, 0, false, false);
					}
				}
				
				var w = renderSizes[context.zoomLevel][0];
				var h = renderSizes[context.zoomLevel][1];
				ctx.drawImage(c_image, 0, 0, w, h);
			}
			
			function setText(text, gctx, x, y, w, h, textSize, centerX, centerY, wrapWords, markLinks, callback){
				if(!textReady){
					return;
				}
				var textCanvas = document.createElement('canvas'); //holds the actual text
				textCanvas.width = w;
				textCanvas.height = h;
				var textContext = textCanvas.getContext('2d');
				
				var charXText = 0;
				var charYText = 0;
				var markText = false;
				var readLink = false;
				var links = [];
				var linkBounds = [];
				
				for(var i=0; i<text.length; i++){
					if(text[i] == "\n"){
						charYText += characterHeights[textSize] + 4;
						charXText = 0;
						continue;
					}
					if(text[i] == " "){
						if(!readLink){
							charXText += 4;
						}
						readLink = false;
						continue;
					}
					if(text[i] == "#" && markLinks){
						markText = !markText;
						if(markText){
							readLink = true;
							links[links.length] = "";
							linkBounds[linkBounds.length] = [charXText, charXText, charYText]; //[startX, endX, Y]
						}
						continue;
					}
					if(readLink){
						var set = -1;
						for(var j=0; j<characterSets[textSize].length; j++){
							if(characterSets[textSize][j].indexOf(text[i]) > -1){
								set = j;
							}
						}
						if(set == -1){
							text = text.substr(0, i) + "?" + text.substr(i+1);
							set = textSize == 0 ? 3 : 1;
						}
						
						var charWidth = characterWidths[textSize][set][characterSets[textSize][set].indexOf(text[i])];
						for(var j=0; j<characterSets[textSize][set].indexOf(text[i]); j++){
							charXCanvas += characterWidths[textSize][set][j];
						}
						
						links[links.length-1] += text[i];
						linkBounds[links.length-1][1] += charWidth;
						continue;
					}
					var set = -1;
					for(var j=0; j<characterSets[textSize].length; j++){
						if(characterSets[textSize][j].indexOf(text[i]) > -1){
							set = j;
						}
					}
					if(set == -1){
						text = text.substr(0, i) + "?" + text.substr(i+1);
						set = textSize == 0 ? 3 : 1;
					}
					var charXCanvas = 0;
					var charWidth = characterWidths[textSize][set][characterSets[textSize][set].indexOf(text[i])];
					for(var j=0; j<characterSets[textSize][set].indexOf(text[i]); j++){
						charXCanvas += characterWidths[textSize][set][j];
					}
//					alert(textContexts + " - " +textContexts[textSize]);
					if(markText){
						var dat = textContexts[textSize][set].getImageData(charXCanvas, 0, charWidth, characterHeights[textSize]);
						var light = 16; //r channel
						var dark = 160; //r channel
						
						for(var j=0; j<dat.data.length; j+=4){
//							alert(dat.data[j]);
							if(dat.data[j] == light){
								dat.data[j] = 24;
								dat.data[j+1] = 110;
								dat.data[j+2] = 246;
							}
							else if(dat.data[j] == dark){
								dat.data[j] = 125;
								dat.data[j+1] = 175;
								dat.data[j+2] = 254;
							}
						}
						
						textContext.putImageData(dat, charXText, charYText);
					}
					else{
						textContext.putImageData(textContexts[textSize][set].getImageData(charXCanvas, 0, charWidth, characterHeights[textSize]), charXText, charYText);
					}
					charXText += charWidth;
					
					if(wrapWords && charXText > w){
						while(text[i] != " "){
							var set = -1;
							for(var j=0; j<characterSets[textSize].length; j++){
								if(characterSets[textSize][j].indexOf(text[i]) > -1){
									set = j;
									break;
								}
							}
							if(set == -1){
								text = text.substr(0, i) + "?" + text.substr(i+1);
								set = textSize == 0 ? 3 : 1;
							}

							charXText -= characterWidths[textSize][set][characterSets[textSize][set].indexOf(text[i])];
//							alert("removing " + characterWidths[textSize][set] + " - " + characterWidths[textSize][set][0]);
							i--;
						}
//						alert(w+" - "+charXText);
						textContext.clearRect(charXText, charYText, w-charXText, characterHeights[textSize]);
						charYText += characterHeights[textSize] + 4;
						charXText = 0;
					}
				}
				
				var i_text = new Image();
				i_text.src = textCanvas.toDataURL("image/png");
				i_text.onload = function(img){
					x = centerX ? Math.round(x - charXText*0.5) : x;
					y = centerY ? Math.round(y - characterHeights[textSize]*0.5) : y;
					gctx.drawImage(i_text,x,y);
//					ctx.drawImage(gctx.canvas, 0, 0);
					if(gctx == ctx_image){ //ugly exception. =(
						ctx.drawImage(c_image, 0, 0, renderSizes[context.zoomLevel][0], renderSizes[context.zoomLevel][1]);
					}
					else if(callback){
						callback();
					}
					else{
						gctx.drawToContext(ctx, true);
					}
				};
				
				for(var i=0; i<links.length; i++){
//					alert(links[i]);
					bounds["link"+links[i]] = new Bounds(gctx.canvas.x + linkBounds[i][0], gctx.canvas.y + y + linkBounds[i][2], linkBounds[i][1]-linkBounds[i][0], characterHeights[textSize], 'text', function(url){return function(){window.open(url, '_blank');}}(links[i]));
//					alert(i);
				}
			}
			
			function updateSelector(){
				ctx.clearRect(c_selector.x, c_selector.y, c_selector.width, c_selector.height);
				ctx_selector.clearRect(0, 0, c_selector.width, c_selector.height);
				
				ctx_selector.drawRoundedRect(sectionLineWidth, sectionLineWidth, c_selector.width-sectionLineWidth*2, sectionLineWidth+63, 6,
											 sectionFill, sectionStroke, sectionLineWidth);
											 
				ctx_selector.drawRoundedRect(sectionLineWidth, sectionLineWidth+66, c_selector.width-sectionLineWidth*2,
											 c_selector.height-sectionLineWidth*2-90, 6, sectionFill, sectionStroke, sectionLineWidth);
				
				for(var i=0; i<tabs.length; i++){
					tabs[i].draw();
				}
				for(var i=0; i<pageButtonsSelector.length; i++){
					pageButtonsSelector[i].draw();
				}
				
				var buttonSet;
				if(context.main == 'self' || context.main == 'opp'){
					buttonSet = characterButtons;
				}
				else if(context.main == 'scene'){
					buttonSet = sceneButtons;
				}
				else{
					buttonSet = uiButtons;
				}
				
				for(var i=0; i<buttonSet.length; i++){
					buttonSet[i].draw();
				}
				
				var curPage;
				var maxPage;
				switch(context.sub){
					case 'trainer':		var char = context.main=='self' ? 0 : 1;
										curPage = context.trainerpage[char] + 1;
										maxPage = maxTrainerPage[char] + 1;
										break;
					case 'pokemon':		curPage = context.pokemonpage + 1;
										maxPage = 6;
										break;
					case 'background':	curPage = 1;
										maxPage = 1;
										break;
					case 'base':		curPage = context.basepage + 1;
										maxPage = 2;
										break;
					case 'tbbackground':curPage = 1;
										maxPage = 1;
										break;
					case 'textbox':		curPage = context.textboxpage + 1;
										maxPage = 4;
										break;
				}
				
				setText(curPage+" / "+maxPage, ctx_selector, c_selector.width*0.5, c_selector.height - 10, 100, 50, 2, true, true);
				
				switch(context.sub){
					case 'trainer':	var pathBase = "characters/trainers/"+(context.main == 'self' ? "back" : "front")+"/";
									var path;
									var char = context.main == 'self' ? 0 : 1;
									var prevFound = 0; //I.e.: Now in 'Friends', prevFound is then amount of trainers in 'Heroes'
									
									var start = 0;
									var end = 0;
									var offset = 0; //used in loop, added to i;
									var maxIcons = iconRows[0]*iconColumns[0];
									
									for(var key in bounds){
										if(key.startsWith("trainer")){
											delete bounds[key];
										}
									}
									
									if(context.trainerpage[char] == 0){
										start = -1;
										end = Math.min(maxIcons-1, totalTrainers[char]);
									}
									else{
										start = 0;
										offset = (maxIcons - 1) + maxIcons*(context.trainerpage[char]-1);
//										alert(context.trainerpage[char] + " - "+offset);
										end = Math.min(maxIcons, totalTrainers[char]-offset);
									}
									resourcesLoading = end - start;
									
									for(var i=start; i<end; i++){ //set Path to point to correct folder (Heroes, Rivals, ...)
										var n = i + offset;
										var img = new Image();
										
										if(i > -1){
											prevFound = 0;
											for(var j=0; j<trainerPaths.length; j++){
												if(n < numTrainers[char][j] + prevFound){
													path = pathBase + trainerPaths[j] + "/";
													break;
												}
												else{
													prevFound += numTrainers[char][j];
												}
											}
											var numTrainer = n - prevFound;
											
											var curGens = trainerGens[char][n]; //all available gens for trainer currently being placed
											var latestGen = curGens[curGens.length-1];
											img.src = path+numTrainer+"/"+latestGen+"/0.png";
										}
										else{
											img.src = "GUI/del.png";
										}
										
										img.onload = function(img, i, n, lg, con){
											return function(){
												resourcesLoading--;
												if(con.main == context.main && con.sub == context.sub && con.tp0 == context.trainerpage[0] && con.tp1 == context.trainerpage[1]){
													createTrainerIcon(img, ctx_selector, i, false, n<maxIcons-1, 'selector', setTrainer(n, lg, 0, n!=-1), false);
												};
											}
										}(img, i, n, latestGen, {"main": context.main, "sub": context.sub, "tp0": context.trainerpage[0], "tp1": context.trainerpage[1]});
									}
									break;
					
					case 'pokemon':	for(var key in bounds){
										if(key.startsWith("pokemon")){
											delete bounds[key];
										}
									}
									var end = Math.min(iconColumns[1]*iconRows[1], 650-iconColumns[1]*iconRows[1]*context.pokemonpage); //650 = numPokemon+delete
									resourcesLoading = end;
									for(var i=0; i<end; i++){
										var n = i + iconColumns[1]*iconRows[1]*context.pokemonpage;
										var img = new Image();
										if(n==0){
											img.src = "GUI/del.png";
										}
										else if(n < 494){
											img.src = "pokemon/heartgold-soulsilver/"+n+".png";
										}
										else{
											img.src = "pokemon/black-white/"+n+".png";
										}
										img.onload = (function(img, i, n, con){
											return function(){
												resourcesLoading--;
												if(con.main == context.main && con.sub == context.sub && con.pokemonpage == context.pokemonpage){
													var x;
													var y;
													var size = 0;
													
													if(n < 494){
														x = iconX + (i%iconColumns[1])*iconSizes[1];
														y = iconY + Math.floor(i/iconColumns[1])*iconSizes[1];
													}
													else{
														x = iconX + (i%iconColumns[1])*iconSizes[1] - (iconSizes[2] - iconSizes[1])*0.5;
														y = iconY + Math.floor(i/iconColumns[1])*iconSizes[1] - (iconSizes[2] - iconSizes[1])*0.5;
														size = 1;
													}
													
	//												ctx.clearRect(c_selector.x, c_selector.y, c_selector.width, c_selector.height);
													ctx_selector.drawImage(img, x, y, iconSizes[1+size], iconSizes[1+size]);
													ctx_selector.drawToContext(ctx, true);
						//							ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
													bounds["pokemon"+i] = new Bounds(x+c_selector.x, y+c_selector.y, iconSizes[1], iconSizes[1], 'selector', setPokemon(n, 11, n!=0)); //11 = BW sprites
												}
											}
										})(img, i, n, {"main": context.main, "sub": context.sub, "pokemonpage": context.pokemonpage});
									}
									break;
					case 'background':	resourcesLoading = numBackgrounds;
										for(var i=-1; i<numBackgrounds; i++){
											var i_bg = new Image();
											i_bg.src = i == -1 ? "GUI/del.png" : "environment/backgrounds/"+i+"/"+backgrounds[i][0];
											i_bg.onload = function(img, i, con){
												return function(){
													resourcesLoading--;
													if(con.main == context.main && con.sub == context.sub){
														var x = boundsX = iconX + ((i+1)%iconColumns[3])*iconSizes[4][0];
														var y = iconY + Math.floor((i+1)/iconColumns[3])*iconSizes[4][1];
														var w = iconSizes[4][0];
														
														if(i == -1){
															x += Math.round((iconSizes[4][0] - iconSizes[4][1])*0.5);
															w = iconSizes[4][1];
														}
														
														ctx_selector.drawImage(img, x, y, w, iconSizes[4][1]);
														ctx_selector.drawToContext(ctx, true);
														bounds["background"+i] = new Bounds(boundsX+c_selector.x, y+c_selector.y, iconSizes[4][0], iconSizes[4][1], 'selector', setBackground(i));
													}
												}
											}(i_bg, i, {"main": context.main, "sub": context.sub});
										}
										break;
									
					case 'base':	for(var key in bounds){
										if(key.startsWith("base")){
											delete bounds[key];
										}
									}
									var start = 0;
									var end = 0;
									var offset = 0; //used in loop, added to i;
									var maxIcons = iconRows[2]*iconColumns[2];
									
									if(context.basepage == 0){
										start = -1;
										end = Math.min(maxIcons-1, numBases);
									}
									else{
										start = 0;
										offset = (maxIcons - 1) + maxIcons*(context.basepage-1);
//										alert(context.trainerpage[char] + " - "+offset);
										end = Math.min(maxIcons, numBases-offset);
									}
									resourcesLoading = end-start;
									
									for(var i=start; i<end; i++){
										var n = i+offset;
										var i_base = new Image();
										if(i == -1){
											i_base.src = "GUI/del.png";
										}
										else{
											if(baseInfo[n].indexOf("thumb.png") != -1){
												i_base.src = "environment/bases/"+n+"/thumb.png"; //[thumb, 0, 1, 2]
											}
											else{
												i_base.src = "environment/bases/"+n+"/1.png"; //no colors; [0, 1] ([front, back])
											}
										}
										i_base.onload = function(img, i, n, con){
											return function(){
												resourcesLoading--;
												if(con.main == context.main && con.sub == context.sub && con.basepage == context.basepage){
													var j = i == n ? 1 : 0;
													var x = boundsX = iconX + ((i+j)%iconColumns[2])*iconSizes[3][0];
													var y = iconY + Math.floor((i+j)/iconColumns[2])*iconSizes[3][1];
													var w = iconSizes[3][0];
													
													if(n == -1){
														x += Math.round((iconSizes[3][0] - iconSizes[3][1])*0.5);
														w = iconSizes[3][1];
													}
													
													ctx_selector.drawImage(img, x, y, w, iconSizes[3][1]);
													ctx_selector.drawToContext(ctx, true);
													bounds["base"+i] = new Bounds(boundsX+c_selector.x, y+c_selector.y, iconSizes[3][0], iconSizes[3][1], 'selector', setBase(n));
												}
											}
										}(i_base, i, n, {"main": context.main, "sub": context.sub, "basepage": context.basepage});
									}
									break;
					case 'textbox':	var start = 0;
									var end = 0;
									var offset = 0; //used in loop, added to i;
									var maxIcons = iconRows[4]*iconColumns[4];
									var numTextBoxes = 60;
									
									if(context.textboxpage == 0){
										start = -1;
										end = Math.min(maxIcons-1, numTextBoxes);
									}
									else{
										start = 0;
										offset = (maxIcons - 1) + maxIcons*(context.textboxpage-1);
//										alert(context.trainerpage[char] + " - "+offset);
										end = Math.min(maxIcons, numTextBoxes-offset);
									}
									resourcesLoading = end-start;
									
									for(var i=start; i<end; i++){
										var n = i+offset;
										var i_tb = new Image();
										i_tb.src = i == -1 ? "GUI/del.png" : "UI/textboxes/"+n+".png";
										i_tb.onload = function(img, i, n, con){
											return function(){
												resourcesLoading--;
												if(con.main == context.main && con.sub == context.sub && con.textboxpage == context.textboxpage){
													var j = i == n ? 1 : 0;
													var x = boundsX = iconX + ((i+j)%iconColumns[4])*(iconSizes[5][0] + 13); //extra spacing
													var y = iconY + 8 + Math.floor((i+j)/iconColumns[4])*(iconSizes[5][1] + 6);
													var w = iconSizes[5][0];
													
													if(n == -1){
														x += Math.round((iconSizes[5][0] - iconSizes[5][1])*0.5);
														w = iconSizes[5][1];
													}
													
													ctx_selector.drawImage(img, x, y, w, iconSizes[5][1]);
													ctx_selector.drawToContext(ctx, true);
													bounds["textbox"+i] = new Bounds(boundsX+c_selector.x, y+c_selector.y, iconSizes[5][0], iconSizes[5][1], 'selector', setTextbox(i==-1?undefined:img));
												}
											}
										}(i_tb, i, n, {"main": context.main, "sub": context.sub, "textboxpage": context.textboxpage});
									}
									break;
					case 'tbbackground':	var swatchSize = 14;
											var sp = 6;
											var n = 0;
											for(var h=0; h<0.9; h+=0.1){ //9
												for(var sv=0.1; sv<1.9; sv+=0.1, n++){ //19
													var s, v;
													if(sv <= 1){
														s = sv;
														v = 1;
													}
													else{
														s = 1;
														v = 1 - (sv-1);
													}
													
													var rgb = hsvToRgb(h, s, v);
													var x = iconX + (swatchSize+sp)*sv*10;
													var y = iconY + 16 + (swatchSize+sp)*h*10;
													ctx_selector.fillStyle = "rgb("+Math.round(rgb[0])+", "+Math.round(rgb[1])+", "+Math.round(rgb[2])+")";
													ctx_selector.fillRect(x, y, swatchSize, swatchSize);
													
													ctx_selector.fillStyle = "rgba(255,255,255,0.25)";
													ctx_selector.fillRect(x, y, swatchSize, swatchSize*0.35);
													
													bounds["tbbackground"+n] = new Bounds(c_selector.x + x, c_selector.y + y, swatchSize, swatchSize, 'selector', setBackgroundColor(h, s, v));
												}
											}
											
											for(var v=1; v<19; v++, n++){ //18 - 1/18 = 0.055555
												var rgb = hsvToRgb(0, 0, 1-v*0.055555);
												var x = iconX + (swatchSize+sp)*v*0.055555*18;
												var y = iconY + 16 + (swatchSize+sp)*10;
												
												ctx_selector.fillStyle = "rgb("+Math.round(rgb[0])+", "+Math.round(rgb[1])+", "+Math.round(rgb[2])+")";
												ctx_selector.fillRect(x, y, swatchSize, swatchSize);
												
												ctx_selector.fillStyle = "rgba(255,255,255,0.25)";
												ctx_selector.fillRect(x, y, swatchSize, swatchSize*0.35);
												
												bounds["tbbackground"+n] = new Bounds(c_selector.x + x, c_selector.y + y, swatchSize, swatchSize, 'selector', setBackgroundColor(0, 0, 1-v*0.055555));
											}
											
											ctx_selector.drawToContext(ctx, true);
											break;
				}
			}
			
			var setBackgroundColor = function(h, s, v){
				return function(){
					var rgb = hsvToRgb(h, s, v);
					textBoxColor = [Math.round(rgb[0]), Math.round(rgb[1]), Math.round(rgb[2]), context.backgroundcolor[3]];
					
					context.backgroundcolor[0] = h;
					context.backgroundcolor[1] = s;
					context.backgroundcolor[2] = v;
					
					updateEditor(0, 2);
					updateImage();
				}
			}
			
			var setTextbox = function(img){
				return function(){
					textBox = img;
//					updateTextArea();
					updateImage();
				}
			}
			
			var setBase = function(i){
				return function(){
					if(i == -1){
						bases[0] = [];
						bases[1] = [];
						updateImage();
					}
					else{
						if(baseInfo[i].indexOf("thumb.png") != -1){ //[thumb, 0, 1, 2]
							basesReady = false;
							var basesLoaded = 0;
							for(var j=0; j<3; j++){
								if(baseInfo[i].indexOf(j+".png") == -1){
									bases[1][j] = undefined;
									basesLoaded++; //technically incorrect
									if(basesLoaded == 3){
										basesReady = true;
										updateImage();
										updateEditor(0, 2);
									}
									continue;
								}
								var i_base = new Image();
								i_base.src = "environment/bases/"+i+"/"+j+".png";
								i_base.onload = function(img, j){
									return function(){
										bases[0] = [];
										bases[1][j] = img;//new Sprite(img, 0, 0);
										basesLoaded++;
										if(basesLoaded == 3){
											basesReady = true;
											updateImage();
											updateEditor(0, 2);
										}
									}
								}(i_base, j);
							}
						}
						else{ //[front, back]
							var i_front = new Image();
							i_front.src = "environment/bases/"+i+"/0.png";
							i_front.onload = function(){
								bases[0][0] = i_front;//new Sprite(i_front, -42, 117);
								updateImage();
							}
							
							var i_back = new Image();
							i_back.src = "environment/bases/"+i+"/1.png";
							i_back.onload = function(){
								bases[0][1] = i_back;//new Sprite(i_back, 128, 56);
								updateImage();
								basesReady = true;
								updateEditor(0, 2);
							}
						}
					}
				}
			}
			
			function getSizes(img, max){
				if(img.width > max || img.height > max){
					var fac = img.width > img.height ? max/img.width : max/img.height;
					return [Math.round(img.width*fac), Math.round(img.height*fac)];
				}
				return [img.width, img.height];
			}
			
			function getSundialY(x){
//				return (sundialBoundsY[1] - sundialBoundsY[0]) + (1-Math.pow((2*Math.max(0, Math.min(x, 1))-1), 2) * (sundialBoundsY[0] - sundialBoundsY[1]));
				return sundialBoundsY[1] + (1-Math.pow((2*Math.max(0, Math.min(x, 1))-1), 2) * (sundialBoundsY[0] - sundialBoundsY[1]));
			}
			
			function createTrainerIcon(img, gctx, i, showPlus, addPos, region, callback, update){ //addPos is for showing "back" button in front e.g.
				var size = getSizes(img, 80);
				var corrX = Math.round((80-size[0])*0.5);
				var corrY = Math.round((80-size[1])*0.5);
				
				var extra = addPos?1:0;
				var x = 0;
				var y = 0;

				if(region == 'selector'){
					x += ((i+extra)%iconColumns[0])*80 + corrX + iconX;
					y += Math.floor((i+extra)/iconColumns[0])*80 + corrY + iconY;
				}
				else{
					x += ((i+extra)%editorColumns[0])*80 + corrX + editorX;
					y += Math.floor((i+extra)/editorColumns[0])*80 + corrY + editorY;
				}				
				gctx.drawImage(img, x, y, size[0], size[1]);
//				gctx.strokeRect(x-corrX, y-corrY, 80, 80);
				gctx.drawToContext(ctx, true);
//				alert(update);
				var boundsName = region == 'selector' ? "trainer" : "editor";
				if(update != undefined){
					bounds[boundsName+i] = new Bounds(x+gctx.canvas.x-corrX, y+gctx.canvas.y-corrY, 80, 80, region, callback, update);
				}
				else{
					bounds[boundsName+i] = new Bounds(x+gctx.canvas.x-corrX, y+gctx.canvas.y-corrY, 80, 80, region, callback);
				}
				
				if(showPlus){
					var i_plus = new Image();
		    		i_plus.src = "GUI/plus.png";
		    		i_plus.onload = function(){
		    			ctx_editor.drawImage(i_plus, Math.round(x+80-Math.max(0, (80-img.width))*0.5)-i_plus.width, y-corrY);
		    			ctx_editor.drawToContext(ctx, true);
		    		}
				}
			}
			
			function updateEditor(numEntity, updateSection, content, setMaxEditorPage, resetEditorPage){ //updateSection = 0: buttons only, 1: content only, 2: both, 3: top half only (sundial)
																										 //content = 'gens'/'frames'
				var clearHeight = 50;
				
				if(updateSection == 0){
					ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, clearHeight);
					ctx_editor.clearRect(0, 0, c_editor.width, clearHeight);
					
					for(var i=0; i<genderButtons.length; i++){
						genderButtons[i].draw();
					}
					shinyButton.draw();
					flyingButton.draw();
					return;
				}
				else if(updateSection == 1){
					ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y + clearHeight, c_editor.width, c_editor.height - clearHeight);
					ctx_editor.clearRect(0, clearHeight, c_editor.width, c_editor.height - clearHeight);
				}
				else if(updateSection == 2){
					ctx.clearRect(c_editor.x, c_editor.y, c_editor.width, c_editor.height);
					ctx_editor.clearRect(0, 0, c_editor.width, c_editor.height);
					
					if(context.sub == 'pokemon'){
						for(var i=0; i<genderButtons.length; i++){
							genderButtons[i].draw();
						}
						shinyButton.draw();
						flyingButton.draw();
					}
				}
				else if(updateSection == 3){
					ctx.clearRect(c_editor.x, c_editor.y, c_editor.width*0.6, c_editor.height*0.6);
					ctx_editor.clearRect(0, 0, c_editor.width*0.6, c_editor.height*0.6);
				}
				
				if(resetEditorPage){ // 'manual override'; used for entering 'frames' content from page 2+.
					context.editorpage = 0;
				}
				
				for(var key in bounds){
					if(key.startsWith("editor")){
						delete bounds[key];
					}
				}
				
				ctx_editor.drawRoundedRect(sectionLineWidth, sectionLineWidth+50, c_editor.width-8, c_editor.height-80, 6, sectionFill, sectionStroke, sectionLineWidth);
				
				if(context.editorstate == 'scene'){
					var lineLength = 0.02;
					ctx_editor.strokeStyle = "rgba(255, 255, 255, 0.5)";
					for(var i=0; i<=1; i += 0.04){
						var x = [sundialBoundsX[0] + i*(sundialBoundsX[1]-sundialBoundsX[0]), sundialBoundsX[0] + (i+lineLength)*(sundialBoundsX[1]-sundialBoundsX[0])];
						var y = [getSundialY(i), getSundialY(i+lineLength)];
						ctx_editor.beginPath();
						ctx_editor.moveTo(x[0]+24,y[0]+24);
						ctx_editor.lineTo(x[1]+24, y[1]+24);
						ctx_editor.stroke();
					}
					
					if(i_sundial){
						var x = Math.max(sundialBoundsX[0], Math.min(sundialBoundsX[0] + context.time*(sundialBoundsX[1]-sundialBoundsX[0]), sundialBoundsX[1]));
						var y = getSundialY(context.time);
						ctx_editor.drawImage(i_sundial, Math.round(x), Math.round(y));
					}
					else{
						i_sundial = new Image();
						i_sundial.src = "GUI/sundial_day.png";
						i_sundial.onload = function(){
//							sundialBoundsX[1] -= i_sundial.width;
							if(context.editorstate == 'scene'){
								ctx_editor.drawImage(i_sundial, sundialBoundsX[0], getSundialY(sundialBoundsX[0])); //fixes 1st-use rounding-error hickup
								ctx_editor.drawToContext(ctx, true);
							}
						}
					}
					
					var elementReady;
					var elements;
					
					switch(context.sub){
						case 'background':	elementReady = backgroundReady;
											elements = background;
											break;
						case 'base':		elementReady = basesReady;
											elements = bases[0].length > 0 ? bases[0] : bases[1];
											break;
					}
					
					if(elementReady){
						var y = 170;
						
						if(elements == bases[0] || elements.length == 1){
							var x = Math.round(c_editor.width*0.5 - elements[1].width*0.5);
							ctx_editor.drawImage(elements[1], x, y, elements[1].width, elements[1].height);
							bounds["editor"+i] = new Bounds(c_editor.x+x, c_editor.y+y, elements[1].width, elements[1].height, 'editor', setTime(1));
						}
						else{
							for(var i=0; i<3; i++){
								if(elements[i]){
									var w = elements[i].width*0.285;
									var h = elements[i].height*0.285;
									var x = 10+(w+5)*i;
									
									if(elements[i]){
										ctx_editor.drawImage(elements[i], x, y, w, h);
									}
									bounds["editor"+i] = new Bounds(c_editor.x+x, c_editor.y+y, w, h, 'editor', setTime(i));
								}
							}
						}
					}
					
					ctx_editor.drawToContext(ctx, true);
					return;
				}
				
				else if(context.editorstate == 'ui'){
					if(backgroundSlidersReady){
						for(var i=0; i<4; i++){
							ctx_editor.drawImage(i_sliderbar, backgroundSliderX, backgroundSliderY + backgroundSliderSv*i);
							ctx_editor.drawImage(i_sliderpaintings[i], backgroundSliderX - 40, backgroundSliderY + backgroundSliderSv*i - Math.round(i_sliderpaintings[i].height*0.5));
						}
						var dx = i_slidercursor.width*0.5;
						var dy = i_slidercursor.height*0.5;
						for(var i=0; i<4; i++){
							var progress = context.backgroundcolor[i] * i_sliderbar.width;
							ctx_editor.drawImage(i_slidercursor, backgroundSliderX - dx + progress, backgroundSliderY + backgroundSliderSv*i - dy);
							bounds["sliderCursor"+i] = new Bounds(c_editor.x + backgroundSliderX - dx + progress, c_editor.y + backgroundSliderY + backgroundSliderSv*i - dy, i_slidercursor.width, i_slidercursor.height);
							bounds["sliderBar"+i] = new Bounds(c_editor.x + backgroundSliderX, c_editor.y + backgroundSliderY + backgroundSliderSv*i - dy, backgroundSliderLength, i_slidercursor.height);
						}
						
					}
					else{
						i_sliderbar = new Image();
						i_sliderbar.src = "GUI/sliderbar.png";
						i_sliderbar.onload = function(){
							backgroundSliderLength = i_sliderbar.width;
							for(var i=0; i<4; i++){
								if(context.editorstate == 'ui'){
									ctx_editor.drawImage(i_sliderbar, backgroundSliderX, backgroundSliderY + backgroundSliderSv*i);
								}
							}
							i_slidercursor = new Image();
							i_slidercursor.src = "GUI/slidercursor.png";
							i_slidercursor.onload = function(){
								if(context.editorstate != 'ui'){
									return;
								}
								var dx = i_slidercursor.width*0.5;
								var dy = i_slidercursor.height*0.5;
								for(var i=0; i<4; i++){
									if(context.editorstate != 'ui'){
										return;
									}
									var progress = context.backgroundcolor[i] * i_sliderbar.width;
									ctx_editor.drawImage(i_slidercursor, backgroundSliderX - dx + progress, backgroundSliderY + backgroundSliderSv*i - dy);
									bounds["sliderCursor"+i] = new Bounds(c_editor.x + backgroundSliderX - dx + progress, c_editor.y + backgroundSliderY + backgroundSliderSv*i - dy, i_slidercursor.width, i_slidercursor.height);
									bounds["sliderBar"+i] = new Bounds(c_editor.x + backgroundSliderX, c_editor.y + backgroundSliderY + backgroundSliderSv*i, backgroundSliderLength, i_slidercursor.height);
								}
								ctx_editor.drawToContext(ctx, true);
							}
							
							var paintingSrc = ["GUI/painting_hue.png", "GUI/painting_sat.png", "GUI/painting_val.png", "GUI/painting_alpha.png"];
							for(var j=0; j<4; j++){
								var i_painting = new Image();
								i_painting.src = paintingSrc[j];
								i_painting.onload = function(img, j){
									return function(){
										if(context.editorstate != 'ui'){
											return;
										}
										i_sliderpaintings[j] = img;
										ctx_editor.drawImage(i_sliderpaintings[j], backgroundSliderX - 40, backgroundSliderY + backgroundSliderSv*j - Math.round(i_sliderpaintings[j].height*0.5));
										ctx_editor.drawToContext(ctx, true);
//										alert(i_sliderpaintings[j]);
									}
								}(i_painting, j);
							}
						}
						backgroundSlidersReady = true;
					}
					
					ctx_editor.drawToContext(ctx, true);
					return;
				}
				
				var spritesFound = 0;
				
				switch(context.editorstate){//switch(context.sub){
					case 'trainer':		if(bounds['setEditorMale']){
											bounds['setEditorMale'].ac = false;
											bounds['setEditorFemale'].ac = false;
											bounds['setEditorShiny'].ac = false;
											bounds['setEditorFlying'].ac = false;
										}
										
										context.editorsubstate = content;
										
										if(numEntity == undefined){
											numEntity = context.trainer;
										}
										
										var path = "characters/trainers/"+(context.main == 'self' ? "back" : "front")+"/";
										var char = context.main == 'self' ? 0 : 1;
										
										if(numEntity == undefined){
											numEntity = context.trainer[char];
										}
										
										var prevTrainers = 0;
										if(numEntity > -1){
											for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", ...]
//												alert(i+": "+numEntity+" < "+numTrainers[char][i]+" + "+prevTrainers);
												if(numEntity < numTrainers[char][i] + prevTrainers){
													path += trainerPaths[i] + "/" + (numEntity - prevTrainers); //path is now .../front/Heroes/1 e.g.
													break;
												}
												else{
													prevTrainers += numTrainers[char][i];
												}
											}
										}
										
										if(content == 'gens'){
											var numIconsMax = editorRows[0]*editorColumns[0];
											var offset = numIconsMax + numIconsMax*(context.editorpage-1);
											var end = Math.min(numIconsMax, trainerGens[char][numEntity].length-offset);
											resourcesLoading = end;
											
											for(var i=0; i<end; i++){
												var n = i+offset;
												var img = new Image();
												img.src = path+"/"+trainerGens[char][numEntity][n]+"/0.png";
//												alert(path + " - "+img.src);
												img.onload = (function(img, i, n, numEntity, con){
													return function(){
														resourcesLoading--;
														if(context.editorstate != 'trainer' || con.editorpage != context.editorpage){
															return;
														}
//														alert(numTrainerFrames[char][numEntity][i]);
														if(numTrainerFrames[char][numEntity][n] > 1){
															createTrainerIcon(img, ctx_editor, i, true, false, 'editor', new function(){return function(){updateEditor(numEntity, updateSection, 'frames', false, true);}}, setTrainer(numEntity, trainerGens[char][numEntity][n], 0, false, true));
														}
														else{
															createTrainerIcon(img, ctx_editor, i, false, false, 'editor', setTrainer(numEntity, trainerGens[char][numEntity][n], 0, false, false));
														}
														
													}
												})(img, i, n, numEntity, {"editorpage": context.editorpage});
											}
										}
										
										else if(content == 'frames'){
											var path = "characters/trainers/"+(context.main == 'self' ? "back" : "front")+"/";
											var prevTrainers = 0;
											for(var i=0; i<trainerPaths.length; i++){ //i < ["Heroes", ...]
												if(numEntity < numTrainers[char][i] + prevTrainers){
													path += trainerPaths[i] + "/" + (numEntity - prevTrainers); //path is now .../front/Heroes/1 e.g.
													break;
												}
												else{
													prevTrainers += numTrainers[char][i];
												}
											}
											
											var gen = trainerGens[char][numEntity].indexOf(context.trainerGen);
											var start = 0;
											var end = 0;
											var offset = 0; //used in loop, added to i;
											
											if(context.editorpage == 0){
												start = -1;
												end = Math.min(editorRows[0]*editorColumns[0]-1, numTrainerFrames[char][numEntity][gen]);
											}
											else{
												start = 0;
												offset = 5 + 6*(context.editorpage-1);
												end = Math.min(editorRows[0]*editorColumns[0], numTrainerFrames[char][numEntity][gen]-offset);
											}
											resourcesLoading = end-start;
											
											for(var i=start; i<end; i++){
												var img = new Image();
												img.src = i == -1 ? "GUI/btn_back.png" : path+"/"+trainerGens[char][numEntity][gen]+"/"+(i+offset)+".png";
												img.onload = (function(img, i, numEntity, offset, con){
													return function(){
														resourcesLoading--;
														if(context.editorstate != 'trainer' || con.editorpage != context.editorpage){
															return;
														}
														if(i == -1){
															createTrainerIcon(img, ctx_editor, i, false, true, 'editor', new function(){return function(){updateEditor(numEntity, updateSection, 'gens', true)}});
														}
														else{
															createTrainerIcon(img, ctx_editor, i, false, offset==0, 'editor', setTrainer(numEntity, trainerGens[char][numEntity][gen], i+offset, false, false));
														}
												    };
												    req.send();
												})(img, i, numEntity, offset, {"editorpage": context.editorpage});
											}
										}
										
										if(setMaxEditorPage){
											context.maxeditorpage = Math.floor((trainerGens[char][numEntity].length-1)/(editorRows[0]*editorColumns[0]));
										}
										
										break;
										

					
					case 'pokemon':		if(bounds['setEditorMale']){
											bounds['setEditorMale'].ac = true;
											bounds['setEditorFemale'].ac = true;
											bounds['setEditorShiny'].ac = true;
											bounds['setEditorFlying'].ac = true;
										}
										
										context.editorsubstate = content;
										context.maxeditorpage = 0;
										
										if(content == 'gens'){
											resourcesLoading = genPaths.length;
											rotateLoadingPokeball(); //extra call to initially show pokeball; script blocks here due to synched requests
											for(var i=0; i<genPaths.length; i++){
												var path = context.main == 'self' ? "pokemon/"+genPaths[i]+"/back/"+numEntity+".png" : "pokemon/"+genPaths[i]+"/"+numEntity+".png";
												var req = new XMLHttpRequest();
											    req.open('GET', "scripts/fileExists.php?path="+path, false);
											    req.onreadystatechange = function(){
											    	if(req.responseText != 1){
											    		resourcesLoading--;
											    		return;
											    	}
											    	var img = new Image();
													img.src = path;
													img.onload = (function(img, i, numEntity, pos){
														return function(){
															resourcesLoading--;
															if(context.editorstate != 'pokemon'){
																return;
															}
															var x;
															var y;
															var size = 0;
															if(i < 11){
																x = editorX + (pos%editorColumns[1])*iconSizes[1];
																y = editorY + Math.floor(pos/editorColumns[1])*iconSizes[1];
															}
															else{
																x = editorX + (pos%editorColumns[1])*iconSizes[1] - (iconSizes[2] - iconSizes[1])*0.5;
																y = editorY + Math.floor(pos/editorColumns[1])*iconSizes[1] - (iconSizes[2] - iconSizes[1])*0.5;
																size = 1;
															}
															
	//														ctx.clearRect(editorX + c_editor.x, editorY + c_editor.y, c_editor.width, c_editor.height);
															ctx_editor.drawImage(img, x, y, iconSizes[1+size], iconSizes[1+size]);
															ctx_editor.drawToContext(ctx, true);
								//							ctx.strokeRect(x, y, iconSizes[1], iconSizes[1]);
															var hasForms = false;
															
															if(numEntity in formPokemon){
																for(var genString in formPokemon[numEntity]){
																	if(genString == "-1"){
																		hasForms = true;
																		break;
																	}
																	else{
																		var genPlusString = genString.split("+");
																		if(genPlusString.length > 1){ //genString is "6+" e.g.
																			if(i >= parseInt(genPlusString[0])){
																				hasForms = true;
																				break;
																			}
																		}
																		else{ //genString is "3,4,5" e.g.
																			var gens = genPlusString[0].split(",");
																			for(var j=0; j<gens.length; j++){
																				if(i == parseInt(gens[j])){
																					hasForms = true;
																					break;
																				}
																			}
																		}
																	}
																}
															}
															
															if(hasForms){
																bounds["editor"+i] = new Bounds(x+c_editor.x, y+c_editor.y, iconSizes[1], iconSizes[1], 'editor', new function(){return function(){updateEditor(numEntity, updateSection, 'frames', false);}}, setPokemon(numEntity, i, false)); //setMaxEditorPage = false???
																
																
																var i_plus = new Image();
																i_plus.src = "GUI/plus.png";
													    		i_plus.onload = function(){
													    			if(context.editorstate == 'pokemon'){
														    			ctx_editor.drawImage(i_plus, x+40-i_plus.width, y);
														    			ctx_editor.drawToContext(ctx, true);
													    			}
													    		}
															}
															else{
																bounds["editor"+i] = new Bounds(x+c_editor.x, y+c_editor.y, iconSizes[1], iconSizes[1], 'editor', setPokemon(numEntity, i, false));
															}
														}
													})(img, i, numEntity, spritesFound);
											    	spritesFound++;
											    };
											    req.send();
											}
										}
										else if(content == 'frames'){ //'forms'
											if(!numEntity){ //currently this can only happen for Unown due to needing multiple pages.. Pesky Unowns.
												numEntity = 201;
											}
											
											if(numEntity == 201){
												context.maxeditorpage = 1;
											}
											
											var forms;
											for(var genString in formPokemon[numEntity]){
												if(genString == "-1"){
													forms = formPokemon[numEntity][genString];
													break;
												}
												else{
													var genPlusString = genString.split("+");
													if(genPlusString.length > 1){ //genString is "6+" e.g.
														if(context.pokemonGen >= parseInt(genPlusString[0])){
															forms = formPokemon[numEntity][genString];
															break;
														}
													}
													else{ //genString is "3,4,5" e.g.
														var gens = genPlusString[0].split(",");
														for(var j=0; j<gens.length; j++){
															if(context.pokemonGen == parseInt(gens[j])){
																forms = formPokemon[numEntity][genString];
																break;
															}
														}
													}
												}
											}
											
											
											var offsetPos = 0;
											var offsetNum = 0;
											var end = Math.min(forms.length - (editorRows[1] * editorColumns[1])*context.editorpage, editorRows[1] * editorColumns[1] - 1);
											resourcesLoading = end;
											
											if(context.editorpage == 0){
												var i_back = new Image();
												i_back.src = "GUI/btn_back.png";
												i_back.onload = function(){
													if(context.editorstate == 'pokemon'){
														ctx_editor.drawImage(i_back, editorX, editorY, iconSizes[1], iconSizes[1]);
														ctx_editor.drawToContext(ctx, true);
													}
												}
												bounds["editor0"] = new Bounds(editorX+c_editor.x, editorY+c_editor.y, iconSizes[1], iconSizes[1], 'editor', new function(){return function(){updateEditor(numEntity, updateSection, 'gens', true);}});
												
												offsetPos = 1;
											}
											else{
												offsetNum = editorRows[1] * editorColumns[1] * context.editorpage;
												end = forms.length - editorRows[1]*editorColumns[1];
											}
											
											for(var i=0; i<end; i++){
												var i_form = new Image();
												i_form.src = "pokemon/"+genPaths[context.pokemonGen]+"/"+numEntity+forms[i+offsetNum]+".png";
												i_form.onload = function(img, i, offsetPos, offsetNum){
													return function(){
														resourcesLoading--;
														if(context.editorstate != 'pokemon'){
															return;
														}
														var x = editorX + ((i+offsetPos)%editorColumns[1])*iconSizes[1];
														var y = editorY + Math.floor((i+offsetPos)/editorColumns[1])*iconSizes[1];
														ctx_editor.drawImage(img, x, y, iconSizes[1], iconSizes[1]);
														ctx_editor.drawToContext(ctx, true);
														bounds["editor"+(i+offsetPos)] = new Bounds(x+c_editor.x, y+c_editor.y, iconSizes[1], iconSizes[1], 'editor', setPokemon(numEntity+forms[i+offsetNum], context.pokemonGen, false));
													}
												}(i_form, i, offsetPos, offsetNum);
											}
										}
										break;
				}
				for(var i=0; i<pageButtonsEditor.length; i++){
					pageButtonsEditor[i].draw();
				}
				
				setText((context.editorpage+1)+" / "+(context.maxeditorpage+1), ctx_editor, c_editor.width*0.5, c_editor.height - 10, 100, 50, 2, true, true);
			}
			
			var openPopup = function(content){
				return function(){
					var oldCanvasState = ctx.getImageData(0, 0, c.width, c.height);
					var oldSub = context.sub;
					
					ctx_popup.clearRect(0, 0, c_popup.width, c_popup.height);
					
					if(content == 'reset'){
					ctx_popup.drawRoundedRect(sectionLineWidth, sectionLineWidth+15, c_popup.width-15-sectionLineWidth-3,
											  c_popup.height*0.5-15-sectionLineWidth-3, 6, "rgba(255, 255, 255, 0.9)", sectionStroke, sectionLineWidth);
					}
					else{
						ctx_popup.drawRoundedRect(sectionLineWidth, sectionLineWidth+15, c_popup.width-15-sectionLineWidth-3,
											  c_popup.height-15-sectionLineWidth-3, 6, "rgba(255, 255, 255, 0.9)", sectionStroke, sectionLineWidth);
					}
					
					context.popupOpen = true;
					context.sub = 'popup';
					
					context.popupContentLoaded = 0;
					context.popupContentCount = 1;
					
//					var i_bg = new Image();
//					i_bg.src = "GUI/pokeball_blue.png";
//					i_bg.onload = function(){
//						ctx_popup.drawImage(i_bg, Math.round(c_popup.width*0.5-i_bg.width*0.5), Math.round(c_popup.height*0.5-i_bg.height*0.5));
//						updatePopup();
//						//switch(content){...}
//					}
					
					switch(content){
						case 'help':		context.popupContentCount += 3;
											setText("Help", ctx_popup, 20, 40, 100, 50, 1, false, false, false, false, updatePopup);
											setText("This is where helpful stuff will be displayed.", ctx_popup, 20, 100, 500, 100, 0, false, false, true,  true, updatePopup);
											var i_corner = new Image();
											i_corner.src = "pokemon/diamond-pearl/202.png";
											i_corner.onload = function(){
												var size = 80;
												var margin = 25;
												ctx_popup.drawImage(i_corner, c_popup.width-20-margin-size, c_popup.height-margin-size, size, size);
												updatePopup();
											}
											break;
						case 'credits':		context.popupContentCount += 3;
											setText("Credits", ctx_popup, 20, 40, 100, 50, 1, false, false, false, false, updatePopup);
											setText("There are a couple of people I would like to thank.\n\nFirst and foremost, a major thank you goes out to veekun.com for making all Pokemon sprites freely and easily available. Major bonus points for the fantastic file structures, naming and ordening of the sprites as well. It made this project 100x more pleasant to work on!\n\nI would also like to extend my thanks to the folks over at #http://www.spriters-resource.com spriters-resource.com# and #http://www.pokecheck.org pokecheck.org# for offering all other sprites I used, such as those of trainers and items. I would specifically like to credit Tsuka, Gridiron, Lemon, Dragoon, Redblueyellow, Witw, KlNothinComin and Xtreme1992 for their work and efforts.\n\nNot to be forgotten are reddit users Cntrldude and those who commented on the thread that inspired this whole shebang.", ctx_popup, 20, 100, 600, 300, 0, false, false, true, true, updatePopup);
											var i_corner = new Image();
											i_corner.src = "characters/trainers/front/Trainers/84/dp/0.png";
											i_corner.onload = function(){
												var size = 80;
												var margin = 25;
												ctx_popup.drawImage(i_corner, c_popup.width-20-margin-size, c_popup.height-margin-size, size, size);
												updatePopup();
											}
											break;
						case 'contribute':	context.popupContentCount += 3;
											setText("Contribute", ctx_popup, 20, 40, 140, 50, 1, false, false, false, false, updatePopup);
											setText("Though the site offers a decent amount of choices in regards to personalizing your screenshot there's always room for improvement. If you find any character sprites, poses, backgrounds, battle bases or anything else that you think would make a good addition, please send me a mail with the material and a source of origin if available.\n\nA few things to keep in mind:\n- All sprites have an alpha channel, with the background being transparent\n- Pokemon sprites are always square (80x80, 96x96) \n- Character sprites can be any size\n- Battle bases are separate from the backgrounds\n- Backgrounds are 256x144 pixels\n- Textboxes are 256x48 pixels\n\nYou can send any materials you have to #mailto:p_boelens@msn.com p_boelens@msn.com#.\n\nIf you wish you make a monetary donation instead, you can do so by making a payment through PayPal to the e-mail adress above, or send a donation through Bitcoin to #bitcoin:1KBrihdqn3Ysz2J22FSyyJsYGPUZoQwXR4?label=PokemonBattleScreenshotDonation 1KBrihdqn3Ysz2J22FSyyJsYGPUZoQwXR4#", ctx_popup, 20, 100, 600, 400, 0, false, false, true, true, updatePopup);
											var i_corner = new Image();
											i_corner.src = "pokemon/black-white/532.png";
											i_corner.onload = function(){
												var size = 96;
												var margin = 10;
												ctx_popup.drawImage(i_corner, c_popup.width-20-margin-size, c_popup.height-margin-size, size, size);
												updatePopup();
											}
											break;
						case 'dev':			context.popupContentCount += 3;
											setText("Project  Source", ctx_popup, 20, 40, 280, 50, 1, false, false, false, false, updatePopup);
											setText("As a big proponent of open-source culture and projects I am releasing this project under the Creative Commons Zero (CC0) license where applicable. This means you are free to use all code, work files and original content produced by me as you see fit, without limitations, for both commercial and non-commercial projects, without needing to provide credit or the original source. Please note that this does -not- apply to any sprites originating from the Pokemon games or official sources, as these are copyrighted and licensed by Nintendo and GameFreak. This also does not void your obligation to credit rippers of the sprites where it's required.\n\nYou can download all the files of this project from the #https://github.com/SenshiSentou/PokemonBattleScreener PBS GitHub page#.", ctx_popup, 20, 100, 600, 200, 0, false, false, true, true, updatePopup);
											var i_corner = new Image();
												i_corner.src = "characters/trainers/front/Trainers/92/bw2/0.png";
												i_corner.onload = function(){
													var margin = 25;
													ctx_popup.drawImage(i_corner, c_popup.width-20-margin-i_corner.width, c_popup.height-margin-i_corner.height);
													updatePopup();
												}
											
											break;
						case 'reset':		context.popupContentCount += 5;
											setText("Reset Image", ctx_popup, c_popup.width*0.5, 40, 280, 50, 1, true, false, false, false, updatePopup);
											setText("Are you sure you want to reset the image?", ctx_popup, c_popup.width*0.5, 100, 500, 50, 0, true, false, true, true, updatePopup);
											var confirmSrc = ["GUI/btn_yes.png", "GUI/btn_no.png"];
											var confirmCallbacks = [reset, undefined];
											var confirmBtnY = 150;
											var confirmBtnSh = 145;
											
											for(var i=0; i<2; i++){
												var i_confirm = new Image();
												i_confirm.src = confirmSrc[i];
												i_confirm.onload = function(img, i){
													return function(){
														var btnX = c_popup.width*0.5 - confirmBtnSh*0.5 - img.width*0.5 + confirmBtnSh*i;
														ctx_popup.drawImage(img, btnX, confirmBtnY);
														updatePopup();
														
														bounds["popup"+i] = new Bounds(c_popup.x+btnX, c_popup.y+confirmBtnY, img.width, img.height, 'popup', closePopup(oldCanvasState, oldSub), confirmCallbacks[i]);
													}
												}(i_confirm, i);
											}
											var i_corner = new Image();
											i_corner.src = "pokemon/black-white/251.png";
											i_corner.onload = function(){
												var margin = 0;
												ctx_popup.drawImage(i_corner, c_popup.width-20-margin-i_corner.width, c_popup.height*0.5-margin-i_corner.height);
												updatePopup();
											}
					}
					
					var i_close = new Image();
					i_close.src = "GUI/btn_close.png";
					i_close.onload = function(){
						ctx_popup.drawImage(i_close, c_popup.width-50, 0);
						bounds["popupClose"] = new Bounds(c_popup.x+c_popup.width-50, c_popup.y, 50, 50, 'popup', closePopup(oldCanvasState, oldSub));
						updatePopup();
					}
				}
			}
			
			var closePopup = function(oldCanvasState, oldSub){
				return function(){
					context.popupOpen = false;
					context.sub = oldSub;
					ctx.clearRect(0, 0, c.width, c.height);
					ctx.putImageData(oldCanvasState, 0, 0);
					
					for(var key in bounds){
						if(key.startsWith("popup") || key.startsWith("link")){
							delete bounds[key];
						}
					}
				}
			}
			
			var updatePopup = function(){
				context.popupContentLoaded++;
				if(context.popupContentLoaded == context.popupContentCount){
					ctx_popup.drawToContext(ctx, false);
				}
			}
			
			function reset(){
				var curMain = context.main;
				var curPokemonNum = context.pokemonNum;
				for(var i=0; i<2; i++){
					context.main = i == 0 ? 'self' : 'opp';
					for(var j=0; j<3; j++){
						context.pokemonNum = j;
						updatePokemon(i, undefined);
					}
					setTrainer(-1)();
				}
				
				pokemonCharacteristics = [[[false, false, false], [false, false, false], [false, false, false]],
										  [[false, false, false], [false, false, false], [false, false, false]]];
				
				
				setBackground(0)();
				setBase(1)();
				textBox = i_textBox;
				context.time = 0;
				context.backgroundcolor = [0,1,0,1];
				var rgb = hsvToRgb(context.backgroundcolor[0], context.backgroundcolor[1], context.backgroundcolor[2]);
				textBoxColor = [Math.round(rgb[0]), Math.round(rgb[1]), Math.round(rgb[2]), context.backgroundcolor[3]];
				
				context.main = curMain;
				context.pokemonNum = curPokemonNum;
				
				genderButtons[0].activate();
				genderButtons[1].deactivate();
				shinyButton.deactivate();
				flyingButton.deactivate();
				
				updateImage();
			}
			
			function rotateLoadingPokeball(){
				ctx.clearRect(pokeballX-1, pokeballY-1, i_pokeball.width+2, i_pokeball.height+2);
				if(resourcesLoading > 0){
					ctx.save();
					ctx.translate(pokeballX + i_pokeball.width*0.5, pokeballY + i_pokeball.height*0.5);
					ctx.rotate(pokeballRotation * 0.0174532925199432957); //Rad --> Deg
					ctx.translate(-i_pokeball.width*0.5, -i_pokeball.height*0.5);
					ctx.drawImage(i_pokeball, 0, 0);
					ctx.restore();
					pokeballRotation += pokeballRotationSpeed;
				}
			}
			
			var setContext = function(cat, val, pokemonNum){
				return function(){
					switch(cat){
						case 'main':			if(context.main != val){
													var _updateEditor = false;
													var activeButtonSet;
													var setSubButtons = true;
													switch(val){
														case 'ui':		activeButtonSet = uiButtons;
																		context.sub = 'tbbackground';
																		context.editorstate = 'ui';
																		_updateEditor = true;
																		break;
														case 'scene':	activeButtonSet = sceneButtons;
																		context.sub = 'background';
																		context.editorstate = 'scene';
																		_updateEditor = true;
																		break;
														case 'self':	activeButtonSet = characterButtons;
																		if(context.main != 'opp'){
																			context.sub = 'trainer';
																		}
																		else{
																			setSubButtons = false;
																		}
																		break;
														case 'opp':		activeButtonSet = characterButtons;
																		if(context.main != 'self'){
																			context.sub = 'trainer';
																		}
																		else{
																			setSubButtons = false;
																		}
																		break;
													}
													context.main = val;
													for(var i=0; i<buttonSets.length; i++){
														for(var j=0; j<buttonSets[i].length; j++){
															if(buttonSets[i] == activeButtonSet){
																bounds[buttonSets[i][j].name].ac = true;
																if(setSubButtons){
																	if(j == 0){
																		buttonSets[i][j].activate();
																	}
																	else{
																		buttonSets[i][j].deactivate();
																	}
																}
															}
															else{
																bounds[buttonSets[i][j].name].ac = false;
															}
														}
													}
												}
												
												if(context.sub == 'pokemon'){
													updatePokemonCharacteristicButtons(context.pokemonNum);
												}
												
												updateSelector();
												if(_updateEditor){
													updateEditor(0, 2);
												}
												break;
						case 'sub':				var oldSub = context.sub;
												context.sub = val;
												if(context.sub == 'pokemon'){
													updatePokemonCharacteristicButtons(pokemonNum);
												}
												if(oldSub != context.sub){
													updateSelector();
												}
												break;
						case 'selectorpage':	if(context.sub=='trainer'){
													var char = context.main=='self' ? 0 : 1;
													var oldPage = context.trainerpage[char];
													context.trainerpage[char] = Math.max(0, Math.min(context.trainerpage[char]+val, maxTrainerPage[char]));
													if(oldPage != context.trainerpage[char]){
														updateSelector();
													}
												}
												else if(context.sub == 'base'){
													var oldPage = context.basepage;
													context.basepage = Math.max(0, Math.min(context.basepage+val, 1));
													if(oldPage != context.basepage){
														updateSelector();
													}
												}
												else if(context.sub == 'textbox'){
													var oldPage = context.textboxpage;
													context.textboxpage = Math.max(0, Math.min(context.textboxpage+val, 3));
													if(oldPage != context.textboxpage){
														updateSelector();
													}
												}
												else if(context.sub == 'pokemon'){
													var oldPage = context.pokemonpage;
													context.pokemonpage = Math.max(0, Math.min(context.pokemonpage+val, 5));
													if(oldPage != context.pokemonpage){
														updateSelector();
													}
												}
												break;
						case 'editorpage':		var char = context.main=='self' ? 0 : 1;
//												if(context.trainer != -1){
													var oldPage = context.editorpage;
													context.editorpage = Math.max(0, Math.min(context.editorpage+val, context.maxeditorpage));
													if(oldPage != context.editorpage){
														updateEditor(undefined, 1, context.editorsubstate, false);
													}
//												}
												break;
						case 'zoom':			var oldZoom = context.zoomLevel;
												context.zoomLevel = val;
												if(oldZoom != context.zoomLevel){
	//												ctx.clearRect(0, 0, renderSizes[oldZoom][0], renderSizes[oldZoom][1]);
													ctx.clearRect(0, 0, 2000, 1000);
													switch(context.zoomLevel){
														case 0:	c.width = 1200;
																c.height = 570;
																break;
														case 1:	c.width = 1260;
																c.height = 570;
																break;
														case 2:	c.width = 1390;
																c.height = 600;
																break;
													}
													var offsetX = renderSizes[context.zoomLevel][0] - renderSizes[oldZoom][0];
													var offsetY = renderSizes[context.zoomLevel][1] - renderSizes[oldZoom][1];
													
													c_selector.x += offsetX;
													c_editor.x += offsetX;
													c_sidebar.x += offsetX;
													c_popup.x += offsetX;
													c_displayPanel.y += offsetY;
													
													ctx_selector.drawToContext(ctx, true);
													ctx_editor.drawToContext(ctx, true);
													ctx_sidebar.drawToContext(ctx, true);
													ctx_displayPanel.drawToContext(ctx, true);
													
													for(var key in bounds){
														if(bounds[key].section == 'zoom'){
															bounds[key].y += offsetY;
														}
														else{
															bounds[key].x += offsetX;
														}
													}
													
													var textY = parseInt(document.getElementById('BattleTextDiv').style.top);
													document.getElementById('BattleTextDiv').style.top = (textY + offsetY)+"px";
													
	//												alert(document.getElementById('battleText').style.width);
													var textBoxW = parseInt(document.getElementById('battleText').style.width);
													document.getElementById('battleText').style.width = (textBoxW + offsetX)+"px";
													
	//												var fs = "12px";
	//												if(context.zoomLevel == 1){
	//													fs = "18px";
	//												}
	//												else if(context.zoomLevel == 2){
	//													fs = "24px";
	//												}
	//												document.getElementById('battleText').style.fontSize = fs;
													
													updateImage();
												}
												break;
					}
				}
			};
			
			var saveImage = function(method){
				return function(){
					switch(method){
						case 'file':	//form = document.getElementById('saveForm');
//										form.elements[0].value = encodeURI(c_image.toDataURL());
//										form.submit();
										
										var form = document.createElement('form');
										form.method = 'post';
										form.action="scripts/saveImage.php";
										form.target="_blank";
										
										var p = document.createElement('input')
										p.type = 'hidden';
										p.name = "path";
										p.value = encodeURI(c_image.toDataURL());
										
										document.body.appendChild(form);
										form.appendChild(p);
										form.submit();
										
										break;
					}
				}
			}
			
			var context = {main:'self', sub:'trainer', pokemonNum:0, pokemonpage:0, trainerpage:[0,0], basepage:0, textboxpage:0,
						   backgroundcolor:[0,1,0,1], editorpage:0, maxeditorpage:0, editorstate:"", editorsubstate:"", trainer:-1, trainerGen:"",
						   pokemon:-1, pokemonGen:"", environment:0, time:0, zoomLevel:0, popupOpen:false, popupContentLoaded:0, popupContentCount:0};
			
			var sectionLineWidth = 3;
			var sectionFill = "rgba(255, 255, 255, 0.5)";
			var sectionStroke = "rgba(0, 0, 0, 1)";
			
			var setBtnX = sectionLineWidth+10;//600;
			var setBtnY = sectionLineWidth+6;//10;
			var setBtnSh = 105; //spacing horizontal
			var setBtnSv = 30; //spacing vertical
			
			var zoomBtnX = 0;
			var zoomBtnY = 0;//250;
			var zoomBtnSh = 75; //spacing horizontal
			
			var saveBtnX = 0;
			var saveBtnY = 50;//250;
			var saveBtnSv = 45; //spacing horizontal
			
			var genderBtnX = 0;
			var shinyBtnX = 100;
			var flyingBtnX = 145;
			var characteristicsBtnY = 10;
						
//			var bounds = {"setTrainerSelf": new Bounds(400, 50, 100, 50, drawPokemon, 492),
//							};
			var bounds = {};
			var tabs = [];
			var sceneButtons = [];
			var uiButtons = [];
			var characterButtons = [];
			var buttonSets = [uiButtons, sceneButtons, characterButtons];
			var zoomButtons = [];
			var sidebarButtons = [];
			var pageButtonsSelector = [];
			var pageButtonsEditor = [];
			var genderButtons = [];
			var shinyButton;
			var flyingButton;
//			var trainerSelf, pokemonSelf1, pokemonSelf2, pokemonSelf3, trainerOpp, pokemonOpp1, pokemonOpp2, pokemonOpp3; //sprites
			var trainers = [];
			var pokemon = [[], []]; //[[self1, self2, self3], [opp1, opp2, opp3]]
			var background = [];
			var bases = [[], []]; //[[front, back], [col0, col1, col2]] //[front back] are separate sprites; colored ones are all-in-one.
//			var textBoxes = [];
			var textBox;
			var genPaths = ["red-green", "red-blue", "yellow", "gold", "silver", "crystal", "ruby-sapphire", //"emerald",
							"firered-leafgreen", "diamond-pearl", "platinum", "heartgold-soulsilver", "black-white"];
			
			var genBoxes = ["GUI/genbox_RG.png", "GUI/genbox_RB.png", "GUI/genbox_Y.png", "GUI/genbox_G.png",
							"GUI/genbox_S.png", "GUI/genbox_C.png", "GUI/genbox_RSE.png", "GUI/genbox_FRLG.png",
							"GUI/genbox_DP.png", "GUI/genbox_P.png", "GUI/genbox_HGSS.png", "GUI/genbox_BW.png"];
			
			//																					  V "Professors"
			var trainerPaths = ["Heroes", "Friends", "Rivals", "Leaders", "E4", "Teams", "Allies", "Support", "Pokestar", "Trainers"];
			var trainerGenPaths = ["rgb", "yellow", "gsc", "rs", "emerald", "rse", "frlg", "dp", "dp2", "platinum", "hgss", "bw", "bw2", "bw22"];
			
//			var unownTypes = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", 
//							  "z", "question", "exclamation"];
			
			//var formPokemon = [172, 201, 351, 386, 412, 413, 421, 422, 423, 479, 487, 492, 550, 555, 585, 586, 641, 642, 645, 646, 647, 648];
			// ... = {numPokemon:{"availableGens*]:[corresponding available suffixes]}}  *as string, N+ is gen N and upwards, -1 is always available
			var formPokemon = {172:{"10": ["", "-spiky-eared"]},
							   201:{"3,4,5": ["-a", "-b", "-c", "-d", "-e", "-f", "-g", "-h", "-i", "-j", "-k", "-l", "-m", "-n", "-o", "-p", "-q", "-r",
							   				  "-s", "-t", "-u", "-v", "-w", "-x", "-y", "-z"],
							   		"5+": ["-a", "-b", "-c", "-d", "-e", "-f", "-g", "-h", "-i", "-j", "-k", "-l", "-m", "-n", "-o", "-p", "-q", "-r",
							   			   "-s", "-t", "-u", "-v", "-w", "-x", "-y", "-z", "-question", "-exclamation"]},
							   351:{"-1": ["", "-sunny", "-rainy", "-snowy"]},
							   386:{"6": ["-normal", "-speed"],
							 		"7": ["-attack", "-defense"],
							 		"8+": ["-normal", "-speed", "-attack", "-defense"]},
							   412:{"-1": ["-plant", "-sandy", "-trash"]},
							   413:{"-1": ["-plant", "-sandy", "-trash"]},
							   421:{"-1": ["-overcast", "-sunshine"]},
							   422:{"-1": ["-west", "-east"]},
							   423:{"-1": ["-west", "-east"]},
							   479:{"9+": ["", "-fan", "-frost", "-heat", "-mow", "-wash"]},
							   487:{"9+": ["-altered", "-origin"]},
							   492:{"9+": ["-land", "-sky"]},
							   493:{"-1": ["-normal", "-electric", "-grass", "-bug", "-flying", "-ice", "-water", "-ghost", "-dragon", "-poison",
							   			   "-psychic", "-fire", "-fighting", "-ground", "-rock", "-steel", "-dark"]},
							   550:{"-1": ["-red-striped", "-blue-striped"]},
							   555:{"-1": ["-standard", "-zen"]},
							   585:{"-1": ["-spring", "-summer", "-autumn", "-winter"]},
							   586:{"-1": ["-spring", "-summer", "-autumn", "-winter"]},
							   641:{"-1": ["-incarnate", "-therian"]},
							   642:{"-1": ["-incarnate", "-therian"]},
							   645:{"-1": ["-incarnate", "-therian"]},
							   646:{"-1": ["", "-white", "-black"]},
							   647:{"-1": ["-ordinary", "-resolute"]},
							   648:{"-1": ["-aria", "-pirouette"]},
							   649:{"-1": ["", "-burn", "-shock", "-douse", "-chill"]}};
			
			var renderSizes = [[256, 190], [384, 285], [512, 380]];
//			var smallPokemon = [1,2,4,5,7,8,10,11,13,14,16,19,20,21,23,27,28,29,32,35,37,39,43,44,46];
			
			var c = document.getElementById("canvas");
			var ctx = c.getContext("2d");
			
			var spriteSize = 80;
			
			var posPokemon = [[[[32, 152]],  [[0, 152], [40, 159]],  [[0, 158], [44, 152], [86, 164]]], //gen 1-11
							  [[[32, 142]],  [[10, 146], [55, 162]],  [[0, 146], [42, 138], [78, 162]]], //gen 12
							  [[[150, 10]],  [[136, 4], [175, 15]],  [[126, 4], [145, 15], [185, 14]]]]; //all opponent
							  //[[single], [double1, double2], [triple1, triple2, triple3]]	x3 (self gen1-12, self gen13, opp) char, singdoubtrip, pos, x/y
			var trainerPos = [[0, 64], [243, 88]];//[185, 88]];
			
			var pokemonCharacteristics = [[[false, false, false], [false, false, false], [false, false, false]],
										  [[false, false, false], [false, false, false], [false, false, false]]]; //[self, other] --> [p1, p2, p3] --> [female, shiny, flying]
			
			var flyingOffset = -25;
			
//			var iconX = sectionLineWidth*2;//600;
			var iconY = sectionLineWidth*2 + 66;
			var iconColumns = [5, 10, 3, 3, 2]; //[trainers, pokemon, bases, bgs, textboxes]
			var iconRows = [5, 11, 7, 6, 10];
			var iconSizes = [80, 40, 48, [128, 64], [128, 72], [256*.75, 48*.75]]; //[trainers, pokemon 1-493, pokemon 494+, [bg_base w, bg_base h], [bg w, bg h], textboxes]
			var pageOffsetX = [140, 80];
			
			var editorX = sectionLineWidth*2;//300;
			var editorY = sectionLineWidth*2 + 50;//70;
			var editorColumns = [3, 6];
			var editorRows = [2, 4];
			
			var backgroundReady = false;
			var numBackgrounds = 0;
			var backgrounds;
			
			var basesReady = false;
			var numBases = 0;
			var baseInfo = [];
			
			var textBoxColor = [0, 0, 0, 1];
						
//			var i_baseF = new Image();
//			i_baseF.src = "environment/bases/0/0.png";
//			i_baseF.onload = function(){
//				bases[0] = new Sprite(i_baseF, -42, 117);
//				updateImage();
//			}
//			
//			var i_baseB = new Image();
//			i_baseB.src = "environment/bases/0/1.png";
//			i_baseB.onload = function(){
//				bases[1] = new Sprite(i_baseB, 128, 56);
//				updateImage();
//			}
			
			var c_image = document.createElement('canvas');
			c_image.width = 256;
			c_image.height = 190;
			c_image.globalCompositeOperation = "source-atop";
			var ctx_image = c_image.getContext('2d');
			
			var c_selector = document.createElement('canvas');
			c_selector.x = 600;
			c_selector.y = 10;
			c_selector.width = 440;
			c_selector.height = 560;
			var ctx_selector = c_selector.getContext('2d');
			
			var c_editor = document.createElement('canvas');
			c_editor.x = 300;
			c_editor.y = 70;
			c_editor.width = 253;
			c_editor.height = 280; //was 302
			var ctx_editor = c_editor.getContext('2d');

			var c_displayPanel = document.createElement('canvas');
			c_displayPanel.x = 0;
			c_displayPanel.y = 250;
			c_displayPanel.width = 255;
			c_displayPanel.height = 140;
			var ctx_displayPanel = c_displayPanel.getContext('2d');
						
//			var c_textBoxes = document.createElement('canvas');
//			var ctx_textBoxes = c_textBoxes.getContext('2d');
//			var i_textBoxes = new Image();
//			i_textBoxes.src = "GUI/textBoxes_HGSS.png";
//			i_textBoxes.onload = function(){
//				c_textBoxes.width = i_textBoxes.width;
//				c_textBoxes.height = i_textBoxes.height;
//				ctx_textBoxes.drawImage(i_textBoxes, 0, 0);
//				textBoxes[0] = ctx_textBoxes.getImageData(0, 0, 256, 46);
//				updateImage();
//			};
			
			var c_sidebar = document.createElement('canvas');
			c_sidebar.x = 1060;
			c_sidebar.y = c_selector.y;
			c_sidebar.width = 70;
			c_sidebar.height = 197;
			var ctx_sidebar = c_sidebar.getContext('2d');
			
			var c_popup = document.createElement('canvas');
			c_popup.x = 280;
			c_popup.y = 40;
			c_popup.width = 650;
			c_popup.height = 450;
			var ctx_popup = c_popup.getContext('2d');
			
			var textCanvases = [[], [], []];
			var textContexts = [[], [], []];
			var textReady = false;
			
			var i_textBox = new Image();
			i_textBox.src = "UI/textboxes/0.png";
			i_textBox.onload = function(){
				textBox = i_textBox;
				updateTextArea();
			}
			
			ctx_sidebar.drawRoundedRect(sectionLineWidth, sectionLineWidth, c_sidebar.width-sectionLineWidth-3, c_sidebar.height-sectionLineWidth-3, 6, sectionFill, sectionStroke, sectionLineWidth);
						
			//sets = [[[smallSet1], [smallSet2], [...]], [[bigSet1], [bigSet2], [...]]]
			var characterSets = [[["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],
							 	  ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],
							 	  ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"],
							 	  [".", ",", ":", ";", "~", "'", "/", "!", "?", "(", ")", "+", "-", "*", "÷", "=", "%", "@", "[", "]", "_", "$"]], //[] = male, female
							 	
							 	[["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],
							 	  ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"]],
							 		  
							 	 [["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"],
							 	  [".", ",", ":", ";", "~", "'", "/", "!", "?", "(", ")", "+", "-", "*", "÷", "=", "%", "@", "[", "]"]]]; //[] = male, female
			
			var characterWidths = [[[7,7,7,7,7,7,7,7,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,7],
									[7,7,7,7,7,6,7,7,3,5,7,4,7,7,7,7,7,6,7,6,7,7,7,7,6,7],
									[7,5,7,7,7,7,7,7,7,7],
									[3,3,3,3,7,3,6,3,8,4,4,8,8,8,8,7,8,8,8,8,8,6]],
									
								   [[14,14,14,14,14,14,14,14,12,14,14,14,14,14,14,14,14,15,14,14,14,14,14,14,16,14],
									[14,14,14,14,14,12,14,14,6,10,14,8,14,14,14,14,14,12,14,12,14,14,14,14,12,14]],
										
								   [[14,10,14,14,14,14,14,14,14,14],
									[6,6,6,6,14,6,12,6,16,8,8,16,16,16,16,14,16,16,16,16]]];
			
			var characterHeights = [13, 26, 26];
			
			var iconX = (c_selector.width - iconSizes[1]*iconColumns[1]) * 0.5;
			
			var sidebarBtnSv = 45;
			var sidebarBtnX = Math.round(c_sidebar.width*0.5-20); //20 = btn.width/2
			var sidebarBtnY = Math.round(6 + sidebarBtnSv - 40); //6 = edge space; 40 = btn.height
			
			var i_sundial;
			var draggingSunDial = false;
			var sundialBoundsX = [20, c_editor.width - 20 - 48]; // -48 = i_sundial.width; not loaded in yet at start
			var sundialBoundsY = [40, 65];//[80, 150];
			var sunDialOffset = [0, 0];
			
			var i_sliderbar;
			var i_slidercursor;
			var i_sliderpaintings = [];
			var backgroundSlidersReady = false;
			var backgroundSliderLength;
			var draggingSliderButton = -1; //-1 is none, [0-3] are [H,S,V,A]
			var sliderButtonOffset = 0;
			var backgroundSliderX = 50;
			var backgroundSliderY = 90;
			var backgroundSliderSv = 35;
			
			var characterButtonsSv = 98;
			
			var pokeballX = 264;
			var pokeballY = 10;
			var pokeballRotation = 0;
			var pokeballRotationSpeed = 20;
			var i_pokeball = new Image();
			i_pokeball.src = "GUI/pokeball.png";
			i_pokeball.onload = function(){
				setInterval(rotateLoadingPokeball, 42);
			}
			
			var resourcesLoading = 0;
			
			
			ctx.clearRect(0, 0, c.width, c.height);
			
			pageButtonsSelector[0] = new Button("setNextPageSel", "GUI/next", c_selector.width*0.5 + pageOffsetX[0]*0.5, //20=width/2
												iconY+iconRows[1]*iconSizes[1], false, ctx_selector, 'selector', setContext('selectorpage', 1));
			pageButtonsSelector[1] = new Button("setPrevPageSel", "GUI/prev", c_selector.width*0.5 - pageOffsetX[0]*0.5 - 40,
												iconY + iconRows[1]*iconSizes[1], false, ctx_selector, 'selector', setContext('selectorpage', -1));
			
			pageButtonsEditor[0] = new Button("setNextPageEd", "GUI/next", c_editor.width*0.5 + pageOffsetX[1]*0.5,
											  c_editor.height - 48, false, ctx_editor, 'editor', setContext('editorpage', 1));
			pageButtonsEditor[1] = new Button("setPrevPageEd", "GUI/prev", c_editor.width*0.5 - pageOffsetX[1]*0.5 - 40,
											  c_editor.height - 48, false, ctx_editor, 'editor', setContext('editorpage', -1));
			
			new Button("setSaveImageFile", "GUI/btn_save", saveBtnX, saveBtnY, false, ctx_displayPanel, 'zoom', saveImage('file'));
//			new Button("setSaveImageMail", "GUI/btn_mail", saveBtnX, saveBtnY+saveBtnSv, false, ctx_displayPanel, 'zoom', saveImage('mail'));
			new Button("setResetImage", "GUI/btn_reset", saveBtnX, saveBtnY+saveBtnSv, false, ctx_displayPanel, 'zoom', openPopup('reset'));
			
			tabs[0] = new Button("setSelf", "GUI/tab_self", setBtnX, setBtnY, true, ctx_selector, 'selector', setContext('main', 'self'),
										   updateUI('tabs', 0), true);
			tabs[1] = new Button("setOpp", "GUI/tab_opponent", setBtnX+characterButtonsSv, setBtnY, true, ctx_selector, 'selector', setContext('main', 'opp'),
										   updateUI('tabs', 1));
			tabs[2] = new Button("setScene", "GUI/tab_scene", setBtnX+characterButtonsSv*2, setBtnY, true, ctx_selector, 'selector', setContext('main', 'scene'),
										   updateUI('tabs', 2));
			tabs[3] = new Button("setUI", "GUI/tab_UI", setBtnX+characterButtonsSv*3, setBtnY, true, ctx_selector, 'selector', setContext('main', 'ui'),
										   updateUI('tabs', 3));
			
//			tabs[0] = new Button("setSelf", "GUI/tab_self", setBtnX, setBtnY, true, ctx_selector, 'selector', setContext('main', 'self'),
//										   updateUI('tabs', 0), true);
//			tabs[1] = new Button("setOpp", "GUI/tab_opponent", setBtnX+105, setBtnY, true, ctx_selector, 'selector', setContext('main', 'opp'),
//										   updateUI('tabs', 1));
//			tabs[2] = new Button("setScene", "GUI/tab_scene", setBtnX+210, setBtnY, true, ctx_selector, 'selector', setContext('main', 'scene'),
//										   updateUI('tabs', 2));
//			tabs[3] = new Button("setUI", "GUI/tab_UI", setBtnX+315, setBtnY, true, ctx_selector, 'selector', setContext('main', 'ui'),
//										   updateUI('tabs', 3));
			
			sceneButtons[0] = new Button("setBackground", "GUI/btn_background", setBtnX, setBtnY+setBtnSv, true, ctx_selector, 'selector',
										 setContext('sub', 'background'), updateUI('sceneButtons', 0), true, false);
			sceneButtons[1] = new Button("setBase", "GUI/btn_base", setBtnX+setBtnSh, setBtnY+setBtnSv, true, ctx_selector, 'selector',
										 setContext('sub', 'base'), updateUI('sceneButtons', 1), false, false);
				
			uiButtons[0] = new Button("setTBBackground", "GUI/btn_background", setBtnX, setBtnY+setBtnSv, true, ctx_selector, 'selector',
										 setContext('sub', 'tbbackground'), updateUI('uiButtons', 0), true, false);
			uiButtons[1] = new Button("setTextbox", "GUI/btn_textbox", setBtnX+setBtnSh, setBtnY+setBtnSv, true, ctx_selector, 'selector',
										 setContext('sub', 'textbox'), updateUI('uiButtons', 1), false, false);
			
			
			characterButtons[0] = new Button("setTrainer", "GUI/btn_blue_trainer", setBtnX, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'trainer'), updateUI('characterButtons', 0), true);
			characterButtons[1] = new Button("setPokemon1", "GUI/btn_blue_pokemon1", setBtnX+setBtnSh, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'pokemon', 0), updateUI('characterButtons', 1));
			characterButtons[2] = new Button("setPokemon2", "GUI/btn_blue_pokemon2", setBtnX+setBtnSh*2, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'pokemon', 1), updateUI('characterButtons', 2));
			characterButtons[3] = new Button("setPokemon3", "GUI/btn_blue_pokemon3", setBtnX+setBtnSh*3, setBtnY+setBtnSv, true, ctx_selector, 'selector',
									setContext('sub', 'pokemon', 2), updateUI('characterButtons', 3));
			
			genderButtons[0] = new Button("setEditorMale", "GUI/btn_male", genderBtnX, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics('gender', false), updateUI('gender', 0), true, false);
			genderButtons[1] = new Button("setEditorFemale", "GUI/btn_female", genderBtnX+40, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics('gender', true), updateUI('gender', 1), false, false);
			
			shinyButton = new Button("setEditorShiny", "GUI/btn_shiny", shinyBtnX, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics('shiny'), updateUI('shiny', 0), false, false);
			flyingButton = new Button("setEditorFlying", "GUI/btn_flying", flyingBtnX, characteristicsBtnY, true, ctx_editor, 'editor',
										  updateCharacteristics('flying'), updateUI('flying', 0), false, false);
			
			zoomButtons[0] = new Button("setZoom1", "GUI/btn_zoom_1x", zoomBtnX, zoomBtnY, true, ctx_displayPanel, 'zoom', setContext('zoom', 0),
										updateUI('zoom', 0), true);
			zoomButtons[1] = new Button("setZoom2", "GUI/btn_zoom_1_5x", zoomBtnX+zoomBtnSh, zoomBtnY, true, ctx_displayPanel, 'zoom',
										setContext('zoom', 1), updateUI('zoom', 1), false);
			zoomButtons[2] = new Button("setZoom3", "GUI/btn_zoom_2x", zoomBtnX+zoomBtnSh*2, zoomBtnY, true, ctx_displayPanel, 'zoom',
										setContext('zoom', 2), updateUI('zoom', 2), false);
			
			sidebarButtons[0] = new Button("sidebarHelp", "GUI/btn_help", sidebarBtnX, sidebarBtnY, false, ctx_sidebar, 'sidebar', openPopup('help'));
			sidebarButtons[1] = new Button("sidebarCredits", "GUI/btn_credits", sidebarBtnX, sidebarBtnY+sidebarBtnSv, false, ctx_sidebar, 'sidebar',
										   openPopup('credits'));
			sidebarButtons[3] = new Button("sidebarContribute", "GUI/btn_contribute", sidebarBtnX, sidebarBtnY+sidebarBtnSv*2, false, ctx_sidebar,
										   'sidebar', openPopup('contribute'));
			sidebarButtons[3] = new Button("sidebarDev", "GUI/btn_dev", sidebarBtnX, sidebarBtnY+sidebarBtnSv*3, false, ctx_sidebar, 'sidebar',
										   openPopup('dev'));
			
			
			
			var numTrainers = [[], []]; //[[self], [opp]]	-->		[numHeroes, numFriends, numRivals, ...]
			var trainerGens = [[], []]; //[[self], [opp]]	-->		[[gensTrainerOne], [gensTrainerTwo]]		-->		['rgb', 'gsc', 'dp', ...]
			var numTrainerFrames = [[], []]; //[[self], [opp]]	-->	[[numFramesGen1Trainer1, numFramesGen2Trainer1], [numFramesGen1Trainer2, ...]]
			var totalTrainers = [];
			var maxTrainerPage = []; //for selector browsing
			
			getBackgroundInfo();
			getBaseInfo();
			getTrainerInfo();
			createTextSheets();
			
			function getBaseInfo(){
				var req = new XMLHttpRequest();
			    req.open('GET', "scripts/backgroundInfo.php?path=environment/bases", false);
			    req.onreadystatechange = function(){
			    	var response = eval("("+req.responseText+")");
		    		var i = 0;
		    		while(response[i] != undefined){
	    				baseInfo[i] = response[i];
	    				i++;
		    		}
			    	numBases = baseInfo.length;
			    	setBase(1)();
			    }
			    req.send();
			}
			
			function getBackgroundInfo(){
				var req = new XMLHttpRequest();
			    req.open('GET', "scripts/backgroundInfo.php?path=environment/backgrounds", false);
			    req.onreadystatechange = function(){
			    	backgrounds = eval("("+req.responseText+")");
//			    	numBackgrounds = backgrounds.length;
//					for(var b in backgrounds){ //mumblemumblestupidfilesystemorder
//						numBackgrounds++;
////						b.sort();
//						alert(backgrounds+" - "+b);
//					}
					var i = 0;
					while(backgrounds[i]){
						numBackgrounds++;
						backgrounds[i].sort();
						i++;
					}
			    	setBackground(0)();
			    }
			    req.send();
			}
			
			function getTrainerInfo(){
				var args = "?path=characters/trainers/&dirs[]=back&dirs[]=front";//folders[]=Heroes&folders[]=Leaders
				for(var i=0; i<trainerPaths.length; i++){
					args += "&folders[]="+trainerPaths[i];
				}
				
				var req = new XMLHttpRequest();
			    req.open('GET', "scripts/trainerSpriteInfo.php"+args, false);
			    req.onreadystatechange = function(){
//			    	alert(req.responseText);
			    	var res = eval("("+req.responseText+")");
//			    	alert(res);
			    	
			    	for(var i=0; i<2; i++){ //front+back
			    		var l = 0; //global trainer number used within k-loop.
			    		for(var j=0; j<res[0].length; j++){ //Heroes, Friends, ...     res[i][j] = [numTrainers, trainerGens, numFrames]
			    			numTrainers[i].push(parseInt(res[i][j][0][0]));
			    			for(var k=0; k<res[i][j][0]; k++, l++){ //for every trainer (gen + numFrames)
//			    				alert(i+" - "+j+ " - " + k + " - " + res[i][j][1][k]);
			    				var temp = res[i][j][1][k].slice(0); //clone of gens
			    				numTrainerFrames[i][l] = [];
			    				trainerGens[i][l] = res[i][j][1][k];
			    				trainerGens[i][l].sort(function(a,b){ //sort by gen
									return trainerGenPaths.indexOf(a) - trainerGenPaths.indexOf(b);
								});
								for(var m=0; m<trainerGens[i][l].length; m++){ //manually set these to match newly sorted order
									numTrainerFrames[i][l][m] = res[i][[j]][2][k][temp.indexOf(trainerGens[i][l][m])];
								}
			    			}
			    		}
			    		totalTrainers[i] = numTrainers[i].reduce(function(a,b){return a+b});
			    		maxTrainerPage[i] = Math.floor(totalTrainers[i] / (iconRows[0]*iconColumns[0]));
			    	}
			    	
			    	tabs[0].activate();
					characterButtons[0].activate();
					zoomButtons[0].activate();
					genderButtons[0].enabled = true; //*sigh* there's always an odd one out.. =P
					
					updateSelector();
//					document.body.style.backgroundImage = "url('GUI/diag_lines_red.png')"; 
			    }
			    req.send();
			}
			
			function createTextSheets(){
				var sheets = [["GUI/text_capitals.png", "GUI/text_lowercase.png", "GUI/text_numbers.png", "GUI/text_symbols.png"],
							  ["GUI/text_capitals_big.png", "GUI/text_lowercase_big.png"],
							  ["GUI/text_numbers_big_white.png", "GUI/text_symbols_big_white.png"]];
				
				var sheetsLoaded = 0;
				var sheetsTotal = sheets.reduce(function(a, b){return a.concat(b)}).length;
				
				for(var i=0; i<sheets.length; i++){
					for(var j=0; j<sheets[i].length; j++){
						var img = new Image();
						img.src = sheets[i][j];
//						alert(img.src);
						img.onload = function(img, i, j){
							return function(){
								textCanvases[i][j] = document.createElement('canvas');
								textCanvases[i][j].width = img.width;
								textCanvases[i][j].height = img.height;
								textContexts[i][j] = textCanvases[i][j].getContext('2d');
								textContexts[i][j].drawImage(img, 0, 0);
								
								sheetsLoaded++;
								if(sheetsLoaded == sheetsTotal){
									textReady = true;
									setTimeout(updateTextArea, 0); //Yikes! Very ugly, but unfortunately needed.
									setTimeout(updateSelector, 0);
								}
							}
						}(img, i, j);
					}
				}
			}
			
			c.onclick = function(e){
				for(var key in bounds){
					if((key.startsWith(context.sub) || key.startsWith("set") || key.startsWith("editor") || key.startsWith("sidebar") ||
						key.startsWith("link")) && bounds[key] && bounds[key].ac && bounds[key].inBounds(e.clientX - c.getBoundingClientRect().left,
																										 e.clientY - c.getBoundingClientRect().top)){
						if(context.popupOpen){
							if(key.startsWith("popup") || key.startsWith("link")){
								var upd = bounds[key].update; //opposite of situation described below
								bounds[key].execute();
								upd();
							}
							continue;
						}
					   	var exec = bounds[key].execute; //crazy caching due to update()s that can clear bounds
						bounds[key].update();
						exec();
						break;
					}
				}
			}
			
			c.onmousemove = function(e) {
				var x = e.clientX - c.getBoundingClientRect().left;
				var y = e.clientY - c.getBoundingClientRect().top;
				
				if(draggingSunDial){
					x += sunDialOffset[0];
					y += sunDialOffset[1];
//					alert(sunDialOffset[0]);
					context.time = (x-(c_editor.x+sundialBoundsX[0]))/((c_editor.x+sundialBoundsX[1])-(c_editor.x+sundialBoundsX[0])); //progress along parabola on scale [0-1]
//					alert(progress);
					
					updateEditor(0, 2);
					updateImage();
				}
				else if(draggingSliderButton != -1){
					x += sliderButtonOffset;
					context.backgroundcolor[draggingSliderButton] = Math.max(0, Math.min(1, (x - (c_editor.x+backgroundSliderX))/i_sliderbar.width));
					
					var rgb = hsvToRgb(context.backgroundcolor[0], context.backgroundcolor[1], context.backgroundcolor[2]);
					textBoxColor = [Math.round(rgb[0]), Math.round(rgb[1]), Math.round(rgb[2]), context.backgroundcolor[3]];
					
//					alert("sliderRanges: "+context.backgroundcolor+" - rgb: "+rgb+" - hsvToRGB(0.1,s,v): "+hsvToRgb(0.1*180, context.backgroundcolor[1], context.backgroundcolor[2]));
//					alert("rgb_old[1]: "+rgb[1]+" - rgb_new[1]: "+hsvToRgb(context.backgroundcolor[0]*180, context.backgroundcolor[1], context.backgroundcolor[2])[1]);
//					alert(textBoxColor[0]);
					
					updateEditor(0, 2);
					updateImage();
				}
				else{
					var foundSprite = [];
					
					for(var key in bounds){
						if(x > c_editor.x && x < c_editor.x + c_editor.width && y > c_editor.y + 50 && y < c_editor.y + c_editor.height - 40 &&
						   bounds[key].inBounds(x, y) && context.editorstate == 'pokemon'){
						   	foundSprite = key.split('editor');
						   	break;
						}
					}
					
					if(foundSprite.length > 0){
	//					alert(foundSprite[1]);
						document.getElementById('GenInfoDiv').style.visibility = 'visible';
						document.getElementById('GenInfoDiv').style.left = (x+20)+"px";
						document.getElementById('GenInfoDiv').style.top = (y+20)+"px";
	//					alert(document.getElementById('GenInfoDiv').style.background-color);
	//					document.getElementById('GenInfoDiv').style.backgroundImage = "url("+genBoxes[foundSprite[1]].src+")";
	//					document.getElementById('GenInfoDiv').innerHTML = genPaths[foundSprite[1]];
						document.getElementById('GenInfoDiv').innerHTML = "<img src="+genBoxes[foundSprite[1]]+">";
					}
					else{
						document.getElementById('GenInfoDiv').style.visibility = 'hidden';
					}
				}
			}
			
			c.onmousedown = function(e){
				var x = e.clientX - c.getBoundingClientRect().left;
				var y = e.clientY - c.getBoundingClientRect().top;
				
				if(context.editorstate == 'scene'){
					var sunX = Math.max(c_editor.x + sundialBoundsX[0], Math.min((c_editor.x + sundialBoundsX[0]) + context.time*(sundialBoundsX[1]-sundialBoundsX[0]), c_editor.x + sundialBoundsX[1]));
					var sunY = c_editor.y + getSundialY(context.time);
					
					var dx = sunX - x + 24; //24 = i_sundial.width/2
					var dy = sunY - y + 24;
					
					if(Math.sqrt(Math.pow(dx, 2)+Math.pow(dy, 2)) <= 24){
						draggingSunDial = true;
						sunDialOffset = [sunX - x, sunY - y];
					}
				}
				else if(context.editorstate == 'ui'){
					for(var key in bounds){
						if(key.startsWith("sliderCursor") && bounds[key].inBounds(x, y)){
						   	draggingSliderButton = parseInt(key.split("sliderCursor")[1]);
						   	sliderButtonOffset = bounds[key].x - x + i_slidercursor.width*0.5;
						   	break;
						}
						else if(key.startsWith("sliderBar") && bounds[key].inBounds(x, y)){
							var n = parseInt(key.split("sliderBar")[1]);
						   	draggingSliderButton = n;
						   	sliderButtonOffset = 0;
						   	context.backgroundcolor[n] = Math.max(0, Math.min(1, (x - (c_editor.x+backgroundSliderX))/i_sliderbar.width));
						   	var rgb = hsvToRgb(context.backgroundcolor[0], context.backgroundcolor[1], context.backgroundcolor[2]);
						   	textBoxColor = [Math.round(rgb[0]), Math.round(rgb[1]), Math.round(rgb[2]), context.backgroundcolor[3]];
						   	
						   	updateEditor(0, 2);
						   	updateImage();
						   	break;
						}
					}
				}
			}
			
			c.onmouseup = function(){
				draggingSunDial = false;
				draggingSliderButton = -1;
			}
      
		</script> 
	</body>
</html>